<HTML xmlns:fc xmlns:v="urn:schemas-microsoft-com:vml">
	<HEAD>
	<link rel="stylesheet" type="text/css" href="menu.css">
	<link rel="stylesheet" type="text/css" href="../css/table.css">	
	<link href=../css/tabstyle.css type=text/css rel=stylesheet>
		<STYLE> 
				v\:* { BEHAVIOR: url(#default#VML);};
					.subpageDiv { BACKGROUND-COLOR: #ffffff; BORDER-BOTTOM: #0000cd 2px outset; BORDER-LEFT: #0000cd 2px ridge; 
					BORDER-RIGHT: #0000cd 2px outset; BORDER-TOP: #0000cd 2px ridge;  OVERFLOW: auto;  
					WIDTH:210MM; HEIGHT:297MM;padding:5mm; }
				* {font-size: 13px;}	

			</STYLE>		
		<script src="../js/fcpub.js"></script>
		<script src="../js/design.js"></script>
		<script src="../js/fctorun.js"></script>		
		<script src="../js/fcbasecont.js"></script>
		<script src="../js/fcrundj.js"></script>
		<script src="../js/table-operations.js"></script>
		<script src="../js/htmlarea.js"></script>					
		
		<script langage="javascript">
			var mylink = document.createElement("link");
			mylink.setAttribute("type","text/css");
			mylink.setAttribute("rel","stylesheet");
			mylink.setAttribute("href","../css/"+fcpubdata.creatorStyle+"/allStyle.css");
			var myhead = document.getElementsByTagName("head")[0];
			myhead.appendChild(mylink);
		</script>
		
		<SCRIPT ID="clientEventHandlersJS" LANGUAGE="javascript">
<!--
var editor = null;
var editortab = null;


var	lngUndo = -1 
var	lngRedo = -1
var oUndo = SetDom("<root></root>")
var oRedo = SetDom("<root></root>")

//---------------------
var curdjid=0; //当前打开的表单的ID，=0表示为新建的表单，或另存为模板。
var saveAsTemplate = 0; //0，代表保存为表单；1，代表保存为模板。
var isTemplate = parent.isTemplate;    //是否是从模板新建而来，true,是从模板新建表单；false，直接新建模板；""，表示没有传该参数
var pstrUserFunction="" //保存当前表单的自定义函数的内容
var pstrAddHtml="" //保存当前表单的附加页面元素的内容
var pstrSplitAddHtml= "<p id=splitaddhtml />" ;
var blnChange=false //改动标志,为真表示改动了要提示保存
var curSelElement =null //
var strXml;
var strID;
var arrtmp1=new Array();
var eform_class= 0;
//控件名称数组
//var ArrName=getControlNameArr()
	var ArrName=new Array();
	ArrName[0]="SKButton";
	ArrName[1]="SKDBedit";
	ArrName[2]="checkbox";
	ArrName[3]="label";
	ArrName[4]="radio" ;
	ArrName[5]="listbox"
	ArrName[6]="textarea"
	ArrName[7]="combobox"
	ArrName[8]="password" ;
	ArrName[9]="upload" ;
	ArrName[10]="SKDBtext";
	ArrName[11]="chart";
	ArrName[12]="dbimg";
	ArrName[13]="img";
	ArrName[14]="SKBILLgrid";
	ArrName[15]="shape";
	ArrName[16]="tab";
	ArrName[17]="div";
	ArrName[18]="DsMain_field";  // SKDBTreeView改为DsMain_field,用来记录最大号
	ArrName[19]="a" ;
	ArrName[20]="button" ;
	ArrName[21]="text" 
	ArrName[22]="hr" ;
	ArrName[23]="checkboxlist"
	ArrName[24]="radiolist"
	ArrName[25]="dropdownlist"
	ArrName[26]="grid"
	ArrName[27]="dataset"
	ArrName[28]="spin"
	ArrName[29]="excel"
	ArrName[30]="tree"
	ArrName[31]="ebshow"; //显示e表控件
	ArrName[32]="ExtGrid";
	ArrName[33]="ExtUpload";
	ArrName[34]="ExtTree";
	//ArrName[28]="ep_borderstyle"

var oContXml = SetDom("<root></root>"); //保存每个控件ID

var ArrNum=new Array(); //保存每种控件的最大号
//var ArrCom = new Array(new Array()) ; //保存每个控件ID
InitControlNo()
/**
初始化控件数组
**/
function InitControlNo(){
	for(var Num=0;Num<ArrName.length;Num++){
		ArrNum[ArrName[Num]]=0;
		//ArrCom[ArrName[Num]] = new Array() ;
	}

}
/**
*窗体装入事件代码
**/
function window_onload() {

	eform_class=parent.Request.QueryString("eform_class").toString(); //表单类别
	if(eform_class =="undefined") eform_class=0;
	SKbillsheet.creatorType = eform_class;
	
	editor = new HTMLArea();
	editor._doc = document;
	editortab = new TableOperations() ;	
	
	var sHtml=GetBillType(); //读取billtype.xml中的记录.
	var my_sHtml = sHtml.substring(sHtml.indexOf('value=')+7,sHtml.indexOf('value=')+9);
	SKbillsheet.type = my_sHtml;

//setLinkSrc( "luna" )
  //  SKbillsheet.unselectable = "on";
    SKbillsheet.contentEditable=true
//    SKbillsheet.designMode="On"
	//SKbillsheet.ATOMICSELECTION=true
    document.execCommand("2D-Position", true, true);
    document.execCommand("MultipleSelection", true, true);
  
  SKbillsheet.focus() ;
  //为了支持一进入设计界面时就以设计模式打开某张表单
  if(isSpace(parent.topdjid) == false)//有djid的情况
  {
		var sdjid=parent.topdjid;
		fcpubdata.djid=sdjid;
		var sql="select djsn from FC_BILLZL where djid='"+sdjid+"'";
		//CopyToPub(sql)
		parent.topdjsn=SqlToField(sql);//通过ID设置DJSN
		SKbillsheet.dj_sn=parent.topdjsn;
		//alert(sql);
		//alert(parent.topdjsn);
		//alert(SKbillsheet.dj_sn);
		//CopyToPub(sdjid)
		DesignDjOpen(sdjid)
		//为了快速重新保存一下多个表单
		if(parent.Request.QueryString("resave").toString() == "yes"){
			SKbillsheet.contxml = "";
			oContXml = null ;
			DesignDjSave("不提示","是");
	  }  
	}
  else if(isSpace(parent.topdjsn) == false){
		//var sql="select djid from FC_BILLZL where djsn='"+parent.topdjsn+"'";
		//CopyToPub(sql)
		//var sdjid=SqlToField(sql);
		//CopyToPub(sdjid)
		DesignDjOpen(sdjid)
		//为了快速重新保存一下多个表单
		if(parent.Request.QueryString("resave").toString() == "yes"){
			SKbillsheet.contxml = "";
			oContXml = null ;
			DesignDjSave("不提示","是");
		}
  }else if(parent.Request.QueryString("ebuse").toString() == "yes"){ //e表用
		e_opendj();
  }else{
		//yes/no 用来决定是否是加控件时自动加字段
		fcpubvar.AutoAddField = parent.Request.QueryString("autoaddfield").toString();		
		AutoAddDsMain();
		var startpage = "" ;
		startpage = parent.Request.QueryString("startpage").toString();
		if(startpage != "no" ){
			//起始页
			//DjOpen("fcs_origPage",parent,"展现","有模式窗口","直接","起始页");
		}		
  }
  
  
	window_onresize();
	if(parent.menu.pubPositionChange == "是"){
		fcpubdata.position="absolute";
	}
	
	if(isTemplate=="true"){//表示是从模板新建表单,清除模板的djsn,djid和名称。
		SKbillsheet.caption="";		
		SKbillsheet.dj_sn = "";
		SKbillsheet.djid = "";
	}
}
function window_onclick() {
	var obj = event.srcElement ;
	var sid = event.srcElement.id ;
	if(sid=="mainbody" || sid == "bigmain" || sid == "middlediv" || sid == "SKbillsheet" ){
		curSelElement=null ;
	}else if(obj.tagName == "TD") {
		try {
			var oP = obj.parentNode.parentNode.parentNode.parentNode ;
			if(oP.controltype == "tab") {
				curSelElement=null ;
				return ;
			}
		}catch(e){} ;
		curSelElement = event.srcElement;
	}
	

}
function resize() {
	ActMoveResize()
}

function move(){
	ActMoveResize()
}
/**
处理在页签控件上移动和调整控件时不能移到页签控件的外面
**/
function ActMoveResize() {
	
   var o=event.srcElement
   if(o == null)return;
   var oP=o.parentNode
   if(oP.tagName=="DIV" && oP.id=="fcpagesub"){
		
		var opwidth=oP.parentNode.style.posWidth
		if(typeof opwidth == "undefined") opwidth=oP.offsetWidth
		var opheight=oP.style.posHeight
		if(typeof opheight == "undefined") opheight=oP.offsetHeight
		
		if(o.offsetWidth>opwidth){
			o.style.width=opwidth
		}
		if(o.offsetHeight>opheight){
			o.style.height=opheight
		}
		if( o.offsetTop>opheight-o.offsetHeight){
		   //window.status="up:"+o.offsetTop
		  // event.returnValue=false
		  o.style.top=opheight-o.offsetHeight  //oP.offsetHeight-5
			
		}
		if(o.offsetLeft>opwidth-o.offsetWidth){
		  o.style.left=opwidth-o.offsetWidth //oP.offsetWidth-5
		
		}
		if(o.offsetTop<0){
			o.style.top=0
		}
		if(o.offsetLeft<0){
			o.style.left=0
		}
   }
   blnChange=true

}
/**
*当控件选择时给当前控件的全局变量
**/

function controlselect() {
	if(event.srcElement.id =="fcpagesubtable") {
		event.returnValue = false;
		return ;
	}
	curSelElement=event.srcElement ;
}
function controlselectcancel() {
	event.returnValue=false
}
/**
打开表单时调用
**/
function pageonload(){
	var oNode = oContXml.documentElement.selectSingleNode("tab") ;
	if(oNode != null ){
		var l=oNode.childNodes.length;
		for(var i=0;i<l;i++){
			var obj = eval(oNode.childNodes(i).text)
			
			//隐藏其它页的select控件
			var oPP=obj;
			var ll=oPP.childNodes.length;
			for(var ii=2;ii<ll;ii++){
				HideListBox(oPP.childNodes(ii),"是")
			}
			//try{
				HideListBox(oPP.childNodes(1),"否")		
			//}catch(E){}
		}			
	}
}
function CancelEvent(){
	if(event.srcElement.id=="fcpagesub" || event.srcElement.id=="fcpagesubtable" )
		event.returnValue=false;
}
function page_onresize(){

//调整子页的大小和页面控件同步
	var obj=event.srcElement
	var l=obj.childNodes.length
	var iWidth=obj.style.posWidth-2
	var iHeight=obj.style.posHeight-20
	if(iHeight<0){
		iHeight=0;
		obj.style.height=20;
	}
	for(var i=1;i<l;i++){
		obj.childNodes(i).style.posWidth=iWidth
		obj.childNodes(i).style.posHeight=iHeight
	}
}
function pageonclick() {
	//alert("dddd")
	var obj=event.srcElement
	//alert(obj.tagName)
	if(obj.tagName=="FONT") obj=obj.parentNode
	if(obj.tagName=="TD"){
		var index=obj.cellIndex
		var oTr=obj.parentNode
		var oP=oTr.parentNode.parentNode //table
		var oPP=oP.parentNode  //整个页签控件
		var l=oPP.childNodes.length;
		for(var i=1;i<l;i++){
			oPP.childNodes(i).style.zIndex=0
			//oPP.childNodes(i).style.display="none"

			oTr.cells(i-1).style.color="black"
			HideListBox(oPP.childNodes(i),"是")
		}
			oPP.childNodes(index+1).style.zIndex=1
			//oPP.childNodes(index+1).style.display="block"
			oTr.cells(index).style.color="red"
			HideListBox(oPP.childNodes(index+1),"否")
	}	
	/*
	if(obj.tagName=="A"){
		var oP=obj.parentNode.parentNode
	}else{
		var oP=obj.parentNode
	}
	var oPP=oP.parentNode  //整个页签控件
	var l=oPP.childNodes.length;
	for(var i=1;i<l;i++){
		oPP.childNodes(i).style.zIndex=0
	}
		oPP.childNodes(index).style.zIndex=1

	var oControlRange = document.body.createControlRange()  ;
	oControlRange.add(oPP.childNodes(index)) ;
	oControlRange.select() ;
	*/	

}
/**
* 换页时隐藏select控件
**/
function HideListBox(oPage,sTag){
	var sTag1
	var oList=oPage.all.tags("select")
	
	var l=oList.length
	if(sTag=="是"){
		for(var i=0;i<l;i++){
			if(oList(i).style.posWidth>0){
				oList(i).backwidth=oList(i).style.posWidth
				oList(i).backheight=oList(i).style.posHeight
				oList(i).style.posWidth=0
				oList(i).style.posHeight=0
			}
		}
	}else{
		for(var i=0;i<l;i++){
			if(isSpace(oList(i).backwidth)==false){
				oList(i).style.width=oList(i).backwidth
				oList(i).style.height=oList(i).backheight
			}
		}
	
	}

}



/**
	点击焦点次序时把界面上的所有的控件ID拼成XML串
	@date 2004-07-13
	@return 返回XML串"<root><taborder>SKButton1</taborder><taborder>SKButton2</taborder><root>"
**/		
function TaborderXml(){
	var l
	var l1
	var arrC=new Array()
	//下列控件有焦点
	arrC[0]=ArrName[0]
	arrC[1]=ArrName[1]
	arrC[2]=ArrName[2]
	arrC[3]=ArrName[4]
	arrC[4]=ArrName[5]
	arrC[5]=ArrName[6]
	arrC[6]=ArrName[7]
	arrC[7]=ArrName[14]
	arrC[8]=ArrName[20]
	arrC[9]=ArrName[21]
	arrC[10]=ArrName[25]
	arrC[11]=ArrName[26]
	arrC[12]=ArrName[28]
	if(isSpace(SKbillsheet.billtaborder)){
		strID="<root>";
		l=arrC.length
		for (var ilen=0;ilen<l;ilen++){
			var oNode = oContXml.documentElement.selectSingleNode(arrC[ilen])
			if( oNode  == null ) continue ;
			l1=oNode.childNodes.length
			for(var k=0;k<l1;k++){
				strID=strID+"<taborder>"+oNode.childNodes(k).text+"</taborder>";
			}
			/*
			l1=ArrNum[arrC[ilen]]
			for(var k=1;k<=l1;k++){
				try{
					obj=eval(arrC[ilen]+k);
					strID=strID+"<taborder>"+arrC[ilen]+k+"</taborder>";
				}catch(e){
					sfind="<taborder>"+arrC[ilen]+k+"</taborder>";
					if(strID.indexOf(sfind)>0){
						strID=RepStr(strID,sfind,"");
					}
				}
			}*/
		}
		strID=strID+"</root>";
	}else{
		//先去掉在taborder中存在而在oContXml中不存在的控件
		var sxml = SKbillsheet.billtaborder ;
		var oX = SetDom(sxml) ;
		var l = oX.documentElement.childNodes.length ;
		for(var i=l-1;i>=0;i--){
			var oNode = oContXml.documentElement.selectSingleNode("//id[. ='"+oX.documentElement.childNodes(i).text+"']") ;
			if( oNode  == null ) {
				oX.documentElement.removeChild(oX.documentElement.childNodes(i));
			}
		}
		sxml=oX.documentElement.xml ;
		//加上新的控件
		strID=RemoveRoot(sxml);
		l=arrC.length
		for (var ilen=0;ilen<l;ilen++){
			var oNode = oContXml.documentElement.selectSingleNode(arrC[ilen])
			if( oNode  == null ) continue ;
			l1=oNode.childNodes.length
			for(var k=0;k<l1;k++){
				var sfind = "<taborder>"+oNode.childNodes(k).text+"</taborder>";
				//如不存在,则加上
				if(strID.indexOf(sfind)<0){ 
					strID=strID+sfind
				}
			}
		
			/*
			l1=ArrNum[arrC[ilen]]
			for(var k=1;k<=l1;k++){
				try{
					obj=eval(arrC[ilen]+k);
					sfind="<taborder>"+arrC[ilen]+k+"</taborder>";
					if(strID.indexOf(sfind)<0){
						strID=strID+sfind;
					}
				}catch(e){
					sfind="<taborder>"+arrC[ilen]+k+"</taborder>";
					if(strID.indexOf(sfind)>=0){
						strID=RepStr(strID,sfind,"");
					}
				}
			}
			*/
		}
		strID = "<root>" + strID + "</root>" ;
	}
	return strID;
}
/**
表单保存
   保存表单：
   	0 合法性检查，单据SN重名检查，
   	1 预处理控件，如将表单控件进行转换后得到新的大HTML串
   	2 创建临时表
   	3 根据djid决定是INSERT还是UPDATE，只保存FC_BILLZL表中的几个字段：djid djsn djposition xmlstr
   	
   	用一个存储过程来保存表单，
   	此过程做如下工作：
   	  1 检查单据SN是否重名，如重名则保存完后给出提示。
   	  2 创建临时表。根据前台传来的命令创建。
   	  3 根据djid决定是INSERT还是UPDATE,如为INSERT,则从FC_MAXBH表中查找biaoshi字段为BIL的记录的recnum字段+1后
   	    当作djid,同时将+1后的值给recnum字段.
   	    
   	    更新FC_BILLZL表中的djid,djsn,dj_name,djlx,djposition,xmltext,designtext,stmptable
	此过程的输入参数：
		djid,djsn,dj_name,djlx,djposition,xmltext,designtext,stmptable   	    

 * 保存表单时，生成运行串要处理：1 数据集控件 2 页签控件 3 各控件的事件（点击） 4 生成建临时表的串
 
 
 * 分保存到数据库和保存到文件
 notalert = "不提示" 表示保存成功后不提示
 nothtml="是" 表示不生成正式表单文件
 iseb = "是" 表示用于e表中的保存参数报表,此时返回一个所需要的结果数组.

*@date 2004-07-21
**/
function DesignDjSave(notalert,nothtml,iseb){	
	if(isTemplate=="true"){ //表示从模板新建表单
		curdjid=0;  //表示保存的时候要重新生成id。
		saveAsTemplate = 0; //为0，代表保存为表单，默认值也为0
	}else if(isTemplate == "false"){  //表示直接在模板管理中新增模板
		curdjid=0;  //表示保存的时候要重新生成id。
		saveAsTemplate = 1; //为1，代表保存为模板，默认值为0
	}
	if(iseb != "是"){
	//存盘前检查
	//djid和dj_sn改由系统确定，故去掉验证 但表单名称（dj_name）还是需要用户输入，故还是得加上dj_name的验证，否则会有错误。		
		if(isSpace(SKbillsheet.caption)){
			var s1 = '表单名称不能为空!请进入表单属性窗口输入表单名称.'
			alert(s1) ;
			var arrForm=new Array();
			arrForm[0]=SKbillsheet;
			arrForm[5]=pstrUserFunction;
			s1 = DjOpen('form',arrForm,'展现',"有模式窗口","直接","表单属性") ;
			return s1
		}
	}
	//维护控件ID
	if(TooContXml()){ 
		openobjlist(); 
	}else{
		return "no empty";
	}
	//
	
		var d=new Date()
		var t = d.getTime();
	if(iseb != "是"){

		//保存 44,84,709,453,居中,不带工具栏,修改,当前窗口,有文件
		var sdjposition=""
		if(IsSpace(SKbillsheet.posleft)){
			sdjposition+=window.screenLeft+","
		}else{
			sdjposition+=SKbillsheet.posleft+","
		}
		if(IsSpace(SKbillsheet.postop)){
			sdjposition+=window.screenTop+","
		}else{
			sdjposition+=SKbillsheet.postop+","
		}
		if(IsSpace(SKbillsheet.poswidth)){
			sdjposition+=window.document.body.clientWidth+","
		}else{
			sdjposition+=SKbillsheet.poswidth+","
		}
		if(IsSpace(SKbillsheet.posheight)){
			sdjposition+=window.document.body.clientHeight+","
		}else{
			sdjposition+=SKbillsheet.posheight+","
		}
		sdjposition+=SKbillsheet.center+","
		sdjposition+=SKbillsheet.toolbar+","
		sdjposition+=SKbillsheet.entertype+","
		sdjposition+=SKbillsheet.window
	}
	var scontrolno=SaveControlNo()
	SKbillsheet.controlno=scontrolno
	//如和下一个ID
	
	//保存控件名称的DOM串
	SKbillsheet.contxml=oContXml.documentElement.xml
	
	//alert(SKbillsheet.contxml);
	
	var SKbillHtml = SKbillsheet.outerHTML;	
	var myDsSub = new Array();     //从数据集的数组。
	var myDsMain = new Array();    //主数据集的数组。
	
	var oNode = oContXml.documentElement.selectSingleNode("dataset");
	if(oNode!=null){
		var l = oNode.childNodes.length;
		for(var i = 0;i < l;i++){						
			myDsMain[i] = oNode.childNodes(i).text;
		}
	}
	
	oNode = oContXml.documentElement.selectSingleNode("grid");
	if(oNode!=null){
		var l = oNode.childNodes.length;
		var j = 0;
		for(var i = 0;i < l;i++){						
			var gridId = oNode.childNodes(i).text;
			var gridXml = SKbillHtml.substring(SKbillHtml.indexOf("<IMG id="+gridId));
			gridXml = gridXml.substring(0,gridXml.indexOf(">"));			
			if(gridXml.indexOf("dataset")!=-1){	
				var gds = gridXml.substring(gridXml.indexOf("dataset=")+9);			  
			    gds = gds.substring(0,gds.indexOf("\""));	
			    var k = 0;
			    for(k = 0;k<j;k++){
			    	if(gds==myDsSub[k]){//grid绑定的数据集相同。不放到数组myDsSub中去。
			    		break;
			    	}
			    }
			    if(k==j){
			    	myDsSub[j] = gds;
			    	j++;
			    }		    
			}
		}		
	}
	//alert("myDsMain:"+myDsMain.length);
	//alert("myDsSub:"+myDsSub.length);
	if(myDsMain.length-myDsSub.length>1){
		alert("一个表单只能有一个主数据集，该表单有多个主数据集，保存之前必须指定保存哪个主数据集！");
	}
	
	
	
	
	
	//为表单添加BLONopen属性。用于打开事件，默认权限控制。加精！！！
	if(IsSpace(SKbillsheet.BLONopen)){
	    SKbillsheet.BLONopen = "setAuthority();";
	}
	
	DesignStr_RunStr_Before(SKbillsheet)
	
	var sDesignText = SKbillsheet.outerHTML ; //保存好设计串

	var sDesignTextBak = sDesignText ;


	
	//附加页面
	var tmpaddhtml=""
	if(pstrAddHtml != ""){
		tmpaddhtml=pstrSplitAddHtml+pstrAddHtml
	}
	if(iseb != "是"){

		//如果是保存到文件,在我们这个系统里面全部都是保存到数据库。
		if (SKbillsheet.isfile == "是") {			
			sDesignText="<![CDATA[<script>"+RepStr(pstrUserFunction,"\r\n","&#13;&#10;")+"</scr"+"ipt> "+sDesignText+tmpaddhtml+"]]>"
	//		var sFile = trim(SKbillsheet.type)+"_"+trim(SKbillsheet.dj_sn)
			var sFile = trim(SKbillsheet.dj_sn)
			var sXml = "<no>"+sFile+"</no><no>"+sDesignText+"</no><no></no>"+"<No>"+fcpubdata.Path+"</No>"
			var ret=savedesignhtml(sXml)
			if(ret == "") {
				if(notalert != "不提示") alert(sFile+".dj文件保存成功!") ;
				return "" ;
			}else{
				alert(ret)
				return ret
			}
			 
		}else{
			sDesignText="<![CDATA["+TransSql(sDesignText)+"]]>"
		
		}
	}
	
	SKbillsheet.removeAttribute("contentEditable")
	SKbillsheet.removeAttribute("unselectable")
	
	DesignStr_RunStr_Before0() ;
	//由设计转为运行串
	var sRun=SKbillsheet.outerHTML
	
	sRun = DesignStr_RunStr_After(sRun,ArrNum)
	if(iseb == "是"){ //e表保存 由此返回 
		return [sDesignTextBak,sRun,pstrUserFunction,pstrAddHtml];	
	}
	SKbillsheet.outerHTML = sDesignTextBak ;
    SKbillsheet.unselectable = "on";
    SKbillsheet.contentEditable=true

	//临时表	
	var stmptable=""
	if(isSpace(SKbillsheet.runsave)==false){
		stmptable=GetTmpTableStr() ;
		stmptable="<![CDATA["+TransSql(stmptable)+"]]>"
	}
	//自定义函数
	var tmpfunc=pstrUserFunction
	//tmpfunc=TransXml(tmpfunc) ;
	tmpfunc=TransSql(repNewLine(repXml(tmpfunc))) ;
	tmpaddhtml="<![CDATA["+TransSql(tmpaddhtml)+"]]>"
	
	sRun="<![CDATA["+TransSql(sRun)+"]]>"

	var sXml="<no>"+curdjid+"</no>"+"<no>"+SKbillsheet.dj_sn+"</no>"+"<no>"+SKbillsheet.caption+"</no>"+"<no>"+SKbillsheet.type+"</no>"
	         +"<no>"+sdjposition+"</no>"+"<no>"+sRun+"</no>"+"<no>"+sDesignText+"</no>"
	         +"<no>"+tmpfunc+"</no>"
	         +"<no>"+stmptable+"</no>"
			 +"<no>"+tmpaddhtml+"</no>"
			 +"<no>"+fcpubdata.databaseTypeName+"</no>"
			 +"<no>"+SKbillsheet.version+"</no>"       //为eform添加版本号
			 +"<no>"+SKbillsheet.creatorType+"</no>"   //表单类别
			 +"<no>"+saveAsTemplate+"</no>";           //是否保存为模板。		
	//CopyToPub(sXml)
	var sRet=designdjsave(sXml);
	var iPos=sRet.indexOf(",");
	var sMsg=sRet.substring(iPos+1,sRet.length);
 	
    //alert("djid:"+curdjid);
    //alert("SKbillsheet.dj_sn:"+SKbillsheet.dj_sn);
    //alert(sXml);
    	
	if(isSpace(sMsg)==false){
		alert(sMsg)
		return sMsg
	}else{ // save ok
		if(curdjid == 0){
			var s=sRet.substring(0,iPos)
		}
		var s=sRet.substring(0,iPos);
		curdjid=parseInt(s);
		SKbillsheet.dj_sn = curdjid;
		parent.topdjsn = curdjid	//给parnt.topdjsn赋值
		//alert(parent.topdjsn);
		
		ChangeWinTitle(SKbillsheet.dj_sn)
		//起始页
		try{
			var arr=new Array(4);
			var str="";
			str=LoadPubData("origPage");
			arr=str.split(";");
			//var oXml=new ActiveXObject("Microsoft.XMLDOM");
			//oXml.async=false;
			// oXml.loadXML (str) ;
			var s1=curdjid+","+SKbillsheet.dj_sn+","+SKbillsheet.caption;
			arr=moveArr(arr,s1);
			var str1="";
			for(var i=0;i<arr.length;i++){
				str1+=arr[i]+";"
			}
			str1=str1.substring(0,str1.length-1);
			SavePubData("origPage",str1);
		}catch(e){}
		//生成正式表单文件
		if(nothtml != "是") {
			//var tmpNo = SKbillsheet.dj_sn ;
			var tmpNo = SKbillsheet.djid ;
			var obj = BillTypeNameToPath(SKbillsheet.type);
			
			//var sPos=loadhtml("select djposition,dj_name from FC_BILLZL where djsn='"+tmpNo+"'",tmpNo,obj.path,obj.extname,function callback(){});
			//var sPos=loadhtml("select djposition,dj_name from FC_BILLZL where djid='"+curdjid+"'",curdjid,obj.path,obj.extname,function callback(){});
			var sPos=loadhtml("select djposition,dj_name from FC_BILLZL where djid='"+curdjid+"'",curdjid,fcpubdata.savePath,fcpubdata.extname,function callback(){});
		}
		if(notalert != "不提示") alert("保存成功！")
		return ""
	}
	function moveArr(arr,sValue){
		if(sValue!=""){
			if(arr[0]!=sValue && arr[1]!=sValue && arr[2]!=sValue && arr[3]!=sValue){
				arr[3]=arr[2];
				arr[2]=arr[1];
				arr[1]=arr[0];
				arr[0]=sValue;
			}else{
				if(arr[0]==sValue || arr[1]==sValue || arr[2]==sValue || arr[3]==sValue){
					var str="";
					for(var i=3;i>=0;i--){
						if(arr[i]==sValue){
							str=arr[i];
							for(var j=i;j>0;j--){
								arr[j]=arr[j-1];
							}
							arr[0]=str;
							break;
						}
					}
				}
			}
		}
		return arr;
	}
	/**
	得到要建的临时表的建表串
	*@date 2004-07-30
	**/
	function GetTmpTableStr(){
		//return ""
		var sRet="";
		var oNode = oContXml.documentElement.selectSingleNode("dataset");
		if(oNode != null) {
			var l = oNode.childNodes.length;
			for(var i=0;i<l;i++){
				var id = oNode.childNodes(i).text;
				var ods=eval(id);
				if(ods.iscreatetable=="是"){
					var sXml=ods.formatxml;
					//西文字段名0 中文名称1 字段类型2 字段宽度3 字段精度4 
					var stablename=ods.temptable;
					sRet+=GetCreateTable(stablename,sXml,true)+";" ;
					
				}			
			}
		}	
		if(sRet != "" ){
			sRet=sRet.substring(0,sRet.length-1);
		}
		return sRet;
		

	}
	
}
/**
打开表单
designtext字段中包含自定义函数的内容，但不含附加页面的内容。
自定义函数的内容在最前面。
*@date 2004-08-02
**/

function DesignDjOpen(djid){
	if(SaveTip() == true) return;
	if (djid<=0) return ""
    if(fcpubdata.databaseTypeName == "oracle"){
    	var sRet = loadClob("<no>designtext</no><no>"+djid+"</no>")
		//sRet = UnTransSql(sRet)   	
    }else{
	    
		var sql="select designtext from FC_BILLZL where djid="+djid ;
		var sRet=SqlToField(sql);
		if(isSpace(sRet)) return ""
	}
	var s = DesignDjOpenSub(sRet,djid);
	return s
}
function DesignDjOpenSub(sRet,djid) {
	//CopyToPub(sRet)
	//自定义函数+"</scr"+"ipt>"+表单画的内容+pstrSplitAddHtml+附加表单的内容
	if(typeof djid == "undefined") djid = 0
	if(typeof sRet == "object"){ //e表时用
		if(IsSpace(sRet[0]) == false){
			SKbillsheet.outerHTML=sRet[0];
		}
		//sRet[1] 为表单运行串
		pstrUserFunction = sRet[2];
		pstrAddHtml = sRet[3]
		
	}else{
		var iEnd=sRet.indexOf("</scr"+"ipt>") ;
		if(iEnd==-1){
			pstrUserFunction="";
			sHtm=sRet
		}else{
			var sHtm=sRet.substring(iEnd+9,sRet.length) ;
			if(isSpace(sHtm)){
				
				return ""
			} 
			pstrUserFunction=sRet.substring(8,iEnd) ;
			pstrUserFunction=unRepNewLine(unRepXml(pstrUserFunction));
		}
		//求 附加页面串
		var ipos=sHtm.indexOf(pstrSplitAddHtml)
		if(ipos==-1){
			pstrAddHtml=""
			
		}else{
			pstrAddHtml=sHtm.substring(ipos+pstrSplitAddHtml.length,sHtm.length)	
			sHtm=sHtm.substring(0,ipos)
		}
		SKbillsheet.outerHTML=sHtm //+pstrAddHtml ;
		//alert(SKbillsheet);
	}
	try{
		if(isSpace(SKbillsheet.controlno)) return "" ;
	}catch(e){
		//当sHtm不是合法的HTM串时出错
		if(isSpace(sHtm) == false){
			alert(sHtm);
		}
		return "" ;
	}
	curdjid=djid ;

	ArrNum = OpenControlNo(SKbillsheet.controlno,ArrNum)
	var scontxml = SKbillsheet.contxml
	if(isSpace(scontxml)  ) {
		scontxml = "<root></root>"
	}
	oContXml=SetDom(scontxml)
	
	//处理控件列表
	openobjlist();
	ShowAllField();
	
	pageonload()
	ChangeWinTitle(SKbillsheet.dj_sn)
	bigmain.focus() ;
	//CopyToPub(bigmain.innerHTML)
	blnChange = false
	return "OK"
}

/**
新建表单,isWizard ="是" 表示有向导
*@date 2004-08-02
**/
function DesignDjNew(isWizard) {
	if(SaveTip() == true) return;
	if(isWizard == "是"){
		var sHtm = DjOpen('fcs_NewWizard',SKbillsheet,'展现',"有模式窗口","直接","新建表单向导");
		if(typeof sHtm == "undefined") return ;
	}else{
		var sHtm = "空" ;
	}
	if( sHtm == "空") {
		curdjid=0 ;
		pstrUserFunction=""
		pstrAddHtml=""
		SKbillsheet.outerHTML ='<div id="SKbillsheet" oncontrolselect="controlselect()" jslib="fcsavedj.js&#13;&#10;fcbasecont.js&#13;&#10;selectdate.js&#13;&#10;~userfunc.js" ></div>'
		//SKbillsheet.unselectable = "on";
		SKbillsheet.contentEditable=true

		//pubDsMain.outerHTML ='<img id="pubDsMain" dsid="DsMain" style="display:none">'
		InitControlNo()
		oContXml = SetDom("<root></root>")
		AutoAddDsMain();		
		ChangeWinTitle("表单设计工具")
		try {
			bigmain.focus() ;
		//	SKbillsheet.focus();
		}catch(e){}
	}else{
	//if( sHtm != "空"){
		SKbillsheet.innerHTML=sHtm;
		//CopyToPub(sHtm)
	}
	if(TooContXml()){openobjlist();ShowAllField();}
	
	if(IsSpace(sHtm) == false && sHtm != "空") 
		blnChange = true;
	else
		blnChange = false;
	
}
/**
表单另存
*@date 2004-08-04
**/
function DesignDjSaveAs(){
	var sRet=window.showModalDialog("input.htm","","status:no;dialogHeight:120px;dialogWidth:400px;dialogTop:180;dialogLeft:250px") 
	if(typeof sRet=="undefined") return
	//SKbillsheet.dj_sn=sRet
	SKbillsheet.dj_name=sRet
	curdjid=0;
	DesignDjSave()	
	ChangeWinTitle(SKbillsheet.dj_sn)
}

/**
表单另存为模板
*@date 2008-05-14
**/
function DesignDjSaveAsTemplate(){			
	if(confirm("您确认要将该表单保存为表单模板吗？")){
		var mydjname = window.showModalDialog("../dj/inputTemplateName.jsp");
		if(mydjname=="undefined" || mydjname == null){
			return;
		}else{
			SKbillsheet.caption = mydjname;
		}
		curdjid=0;  //表示保存的时候要重新生成id。
		saveAsTemplate = 1; //表示保存为模板。
		DesignDjSave();
	}		
}
/**
存盘前提示
*@date 2004-08-05
**/
function SaveTip(){
	if(blnChange == false) return 
	var ret = window.confirm("确定保存当前表单吗？");		
	if (ret == true) {
		DesignDjSave();
	}

	return ret;
}

/**
保存找到当前表单中控件的号码
*@date 2004-08-04
**/
function SaveControlNo() {
//ArrNum['SKButton']++
	var sRet=""
	for(var Num=0;Num<ArrName.length;Num++){
		sRet+=ArrName[Num]+":"+ArrNum[ArrName[Num]]+";" ;
//		sRet+=ArrNum[ArrName[Num]]+";" ;
	}
	sRet=sRet.substring(0,sRet.length-1);
	return sRet ;
}

function window_onbeforeunload() {
	
	if(blnChange == false) return 
	event.returnValue="离开当前页面将导致当前输入的数据丢失!"
}

function main_onbeforeeditfocus() {
	var obj = event.srcElement ;
	if(obj.tagName == "TD" ||obj.id =="SKbillsheet" ) return ;
	event.returnValue = false
}
function main_exec(scomm) {
	document.execCommand(scomm)

}
function window_onresize() {
	var iwidth =document.body.offsetWidth - 2
	var iheight =document.body.offsetHeight - 2
	if(iwidth<0) iwidth=100;
	if(iheight<0) iheight=100;
	srcHtml.style.width = iwidth
	srcHtml.style.height = iheight
	//如设置了窗口宽度,则始终是设置的宽度值,否则为窗口的宽度
	var iwidth1 = parseInt(SKbillsheet.poswidth)
	if(isSpace(SKbillsheet.poswidth) == false ){
		//if(bigmain.offsetWidth < iwidth1 ){
			bigmain.style.width = iwidth1
		//}
	}else{
		bigmain.style.width = iwidth
	}
	var iheight1 = parseInt(SKbillsheet.posheight)
	if(isSpace(SKbillsheet.posheight) == false ){
		//if(bigmain.offsetHeight < iheight1 ){
			bigmain.style.height = iheight1
		//}
	}else{
		bigmain.style.height = iheight
	}
	//middlediv.style.width = bigmain.style.width
	//middlediv.style.height = bigmain.style.height
}
/**
删除ocontxml中值相同的节点
*@date 2005-03-30
**/
function DelSameNameNode() {
	var curid = ""
	var l=oContXml.documentElement.childNodes.length
	for(var i=0;i<l;i++){
		var l1 = oContXml.documentElement.childNodes(i).childNodes.length
		for(var j=l1-1;j>=0;j--){
			if(curid == oContXml.documentElement.childNodes(i).childNodes(j).text) {
				oContXml.documentElement.childNodes(i).removeChild(oContXml.documentElement.childNodes(i).childNodes(j))
				continue
			}
			curid = oContXml.documentElement.childNodes(i).childNodes(j).text ;
		}
	}
}

/**
* 由界面上的控件 ==> oContXml 
*@return false 表示id重复,没有做同步工作,
*@date 2005-04-19
**/
function TooContXml() {
	var sRet = "<root>"
	var arrXml = new Array()
	var o = SKbillsheet.all
	var l=o.length ;
	for(var i=0;i<l;i++){
		var sid = o[i].id
		var scontroltype = o[i].controltype
		if(typeof(sid) == "undefined" ) continue
		//如没有controltype,表示是旧的控件,则要补上,2006-01-23 remove
		/*
		if(typeof(scontroltype) == "undefined") {
			var ll=ArrName.length;
			for (var ii=0;ii<ll;ii++){
				if (sid.indexOf(ArrName[ii])==0){
					o[i].controltype = ArrName[ii] ;
					scontroltype = o[i].controltype ;
					break ;
				}
			}
			
		}*/
		
		if(typeof arrXml[scontroltype] == "undefined") arrXml[scontroltype] =""
		var tmp = "<id>"+ sid +"</id>" ;
		if(arrXml[scontroltype].indexOf(tmp) >= 0  && sid != "" && sid != "fcpagesub" && sid != "fcpagesubtable" ){
			alert("注意: "+sid+"重复!请修改." )
			return false ;
		}else if(sid == "" || sid == "fcpagesub" || sid == "fcpagesubtable"){
			
		}else{
			arrXml[scontroltype] += tmp ;
		}
		
	}
	var l = ArrName.length ;
	for(var i=0;i<l;i++){
		if(isSpace(arrXml[ArrName[i]]) == false){
			sRet += "<"+ ArrName[i] +">" + arrXml[ArrName[i]]+"</"+ ArrName[i] +">"
			
		}
	}
	
	sRet += "</root>"
	
	
	oContXml = SetDom(sRet) ;
	//计算新的tab串
	//SKbillsheet.billtaborder = "" ; //清空以重算
	SKbillsheet.billtaborder = TaborderXml() ;
	return true
}	
/**
* 在设计窗口点右键菜单的调用
*@date 2005-08-11
**/
function main_onRightClick() {
	var tagName = event.srcElement.tagName ;
	
	if(tagName == "TD"){
		//RightMenu.DataSource="MenuTab.value" ;
		RightMenuTab.showMenu(window,RightMenuTab.dataSource.documentElement.selectSingleNode('//MenuItem'),window.document.body,event.x,event.y) ;
	}else{
		//RightMenu.DataSource="MenuCode.value" ;
		RightMenu.showMenu(window,RightMenu.dataSource.documentElement.selectSingleNode('//MenuItem'),window.document.body,event.x,event.y) ;
	}
		//RightMenu.Init() ;
		

}
/**
*设置TD上选中的文本的属性
*@date 2005-08-22
**/
function SetSelTextProp() {
	var sRet=DjOpen('fcs_selprop',window,'展现','无模式窗口','直接','设置当前选中文本的属性');
}
/*
function bill_ondrop() {
	event.returnValue = false
	//alert(event.srcElement.outerHTML)
	//var s1 = event.dataTransfer.getData("Text") ;
	
}*/

function mytest(){
	var oControlRange = document.body.createControlRange();
	//oControlRange.add(SKbillsheet);
	oControlRange.select();

//	event.returnValue =false
//	test1.value=SaveControlNo()
}
function mytest1(){
	//OpenControlNo(test1.value)
	htmltocont('<button controltype="FCButton" id="FCButton1" >aa</button>','FCButton')
}

//-->.
		</SCRIPT>
	</HEAD>
	<BODY onbeforeunload="window_onbeforeunload()" onload="window_onload()" id="mainbody"
	onresize="window_onresize()"
		>
		<!--<input type="button" value="test" onclick="mytest()"><input id=test1 >
		<input type="button" value="test1" onclick="mytest1()" >
				<button onclick="document.execCommand('Delete')">test</button>
			<table border=1 style="table-layout:fixed;position:absolute">
				<colgroup><col style="width:60"><col style="width:160"><col style="width:100"></colgroup>
				<tr><td>aa</td><td>遗传2基因</td><td>遗传2基因ss</td></tr>
				<tr><td>aa</td><td><input id=test1 NAME="test1"></td><td>遗传1基因ss</td></tr>
				<tr><td>aa</td><td>遗传基因</td><td>遗传基因ss</td></tr>
			</table>
<button ID="Button1">设计</button><button ID="Button2">HTML</button>
		-->
		
		<div id="bigmain" ondblclick="main_ondblclick()" onbeforeeditfocus="main_onbeforeeditfocus()"
		onclick="window_onclick()" onkeydown="main_onkeydown()"
		onkeyup="main_onkeyup()" oncontextmenu="main_onRightClick()"
		
		
		>
		<div id="middlediv" style="overflow:auto;"  >
			<div id="SKbillsheet" oncontrolselect="controlselect()" jslib="fcsavedj.js&#13;&#10;fcbasecont.js&#13;&#10;selectdate.js&#13;&#10;~userfunc.js" >
			</div>
		</div>
		</div>
		
		<textarea rows="17" id="srcHtml" cols="73" style="display:none" >
		</textarea>
		
		<WebMenu DataSource="MenuCode.value" class="WebMenu" id="RightMenu" Width="100" Effect="3" MenuType="1" ></WebMenu>
		<textarea rows="17" id="MenuCode" cols="73" style="display:none" NAME="MenuCode">
				
				<Root>
					<MenuItem  hasSub="1" subWidth="160" >
							<MenuItem Func="javascript:CopyCont();main_onkeydel();" Text="剪切 ctrl+x" img="../images/ef_design_cut.gif" />  
							<MenuItem Func="javascript:CopyCont();" Text="复制 ctrl+c" img="../images/ef_design_copy.gif" />  
							<MenuItem Func="javascript:if(PasteCont()==false) main_exec('Paste');" Text="粘贴 ctrl+v" img="../images/ef_design_paste.gif" hasLine="1" />
							<MenuItem Func="javascript:main_onkeydel();" Text="删除	Del" img="../images/ef_design_delete.gif" hasLine="1"/>
							<MenuItem Func="javascript:main_ondblclick();" Text="属性" img="../images/ef_design_shuxing.gif" hasLine="1"/>
							
							<MenuItem Func="javascript:SetSelTextProp();" Text="选中文本属性" img="../images/ef_tab_cell_prop.gif" />  
					</MenuItem>
				</Root>

		</textarea>
		<WebMenu DataSource="MenuTab.value" class="WebMenu" id="RightMenuTab" Width="100" Effect="3" MenuType="1" ></WebMenu>
		<textarea rows="17" id="MenuTab" cols="73" style="display:none" >
				<Root>
					<MenuItem  hasSub="1" subWidth="160" >
							<MenuItem Func="javascript:editortab.buttonPress(editor,'TO-table-prop');" Text="表格属性" hasLine="1" img="../images/ef_tab_table_prop.gif" />  
							<MenuItem Func="javascript:editortab.buttonPress(editor,'TO-row-insert-above');" Text="在前面加一行" img="../images/ef_tab_row_insert_above.gif" />  
							<MenuItem Func="javascript:editortab.buttonPress(editor,'TO-row-insert-under');" Text="在后面加一行" img="../images/ef_tab_row_insert_under.gif" />  
							<MenuItem Func="javascript:editortab.buttonPress(editor,'TO-row-delete');" Text="删除当前行" img="../images/ef_tab_row_delete.gif" />  
							<MenuItem Func="javascript:editortab.buttonPress(editor,'TO-row-split');" Text="按行拆分单元格" hasLine="1" img="../images/ef_tab_row_split.gif" />
							  
							<MenuItem Func="javascript:editortab.buttonPress(editor,'TO-col-insert-before');" Text="在前面加一列" img="../images/ef_tab_col_insert_before.gif" />  
							<MenuItem Func="javascript:editortab.buttonPress(editor,'TO-col-insert-after');" Text="在后面加一列" img="../images/ef_tab_col_insert_after.gif" />  
							<MenuItem Func="javascript:editortab.buttonPress(editor,'TO-col-delete');" Text="删除当前列" img="../images/ef_tab_col_delete.gif" />  
							<MenuItem Func="javascript:editortab.buttonPress(editor,'TO-col-split');" Text="按列拆分单元格" hasLine="1" img="../images/ef_tab_col_split.gif" />

							<MenuItem Func="javascript:editortab.buttonPress(editor,'TO-cell-prop');" Text="单元格属性" hasLine="1" img="../images/ef_tab_cell_prop.gif" />  
							<MenuItem Func="javascript:editortab.buttonPress(editor,'TO-cell-insert-before');" Text="在前面加单元格" img="../images/ef_tab_cell_insert_before.gif" />  
							<MenuItem Func="javascript:editortab.buttonPress(editor,'TO-cell-insert-after');" Text="在后面加单元格" img="../images/ef_tab_cell_insert_after.gif" />  
							<MenuItem Func="javascript:editortab.buttonPress(editor,'TO-cell-delete');" Text="删除当前单元格" img="../images/ef_tab_cell_delete.gif" />  
							<MenuItem Func="javascript:editortab.buttonPress(editor,'TO-cell-merge');" Text="合并单元格" img="../images/ef_tab_cell_merge.gif" />  
							<MenuItem Func="javascript:editortab.buttonPress(editor,'TO-cell-split');" Text="拆分单元格" hasLine="1" img="../images/ef_tab_cell_split.gif" />  
							
							<MenuItem Func="javascript:SetSelTextProp();" Text="选中文本属性" img="../images/ef_tab_cell_prop.gif" />  

					</MenuItem>
				</Root>

		</textarea>	
		
	</BODY>
</HTML>
