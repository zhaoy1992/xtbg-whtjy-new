<HTML xmlns:fc xmlns:v="urn:schemas-microsoft-com:vml">
	<HEAD>
	<link rel="stylesheet" type="text/css" href="menu.css">
	<link rel="stylesheet" type="text/css" href="../css/table.css">	
	<link href=../css/tabstyle.css type=text/css rel=stylesheet>
		<STYLE> 
				v\:* { BEHAVIOR: url(#default#VML);};
					.subpageDiv { BACKGROUND-COLOR: #ffffff; BORDER-BOTTOM: #0000cd 2px outset; BORDER-LEFT: #0000cd 2px ridge; 
					BORDER-RIGHT: #0000cd 2px outset; BORDER-TOP: #0000cd 2px ridge;  OVERFLOW: auto;  
					WIDTH:210MM; HEIGHT:297MM;padding:5mm; }
				* {font-size: 13px;}	

			</STYLE>		
		<script src="../js/fcpub.js"></script>
		<script src="../js/design.js"></script>
		<script src="../js/fcopendj.js"></script>
		<script src="../js/fctorun.js"></script>		
		<script src="../js/fcbasecont.js"></script>
		<script src="../js/fcrundj.js"></script>
		<script src="../js/table-operations.js"></script>
		<script src="../js/htmlarea.js"></script>				
		<script src="../js/fcselfuse.js"></script>
		<script src="../js/ccpub.js"></script>		
		
		<script langage="javascript">
		    fcpubdata.creatorStyle=parent.cssfolder;
			var designStylePath = parent.stylePath;
			var mylink = document.createElement("link");
			mylink.setAttribute("type","text/css");
			mylink.setAttribute("rel","stylesheet");
			mylink.setAttribute("href",designStylePath+"css/"+fcpubdata.creatorStyle+"/allStyle.css");
			var myhead = document.getElementsByTagName("head")[0];
			myhead.appendChild(mylink);
			
			//作用：退出iWebOffice
			function UnLoadWebOffice(){    				
				var iWebOffice = document.getElementsByName("WebOffice")[0];  //获取控件对象。 				
				if(iWebOffice!=null && iWebOffice!="undefined"){ 										
					iWebOffice.WebClose();									
				}
			}
		</script>
		
		<SCRIPT ID="clientEventHandlersJS" LANGUAGE="javascript">
<!--
var editor = null;
var editortab = null;


var	lngUndo = -1 
var	lngRedo = -1
var oUndo = SetDom("<root></root>")
var oRedo = SetDom("<root></root>")

//---------------------
var curdjid=0; //当前打开的表单的ID，=0表示为新建的表单，或另存为模板。
var saveAsTemplate = 0; //0，代表保存为表单；1，代表保存为模板。
var isTemplate = parent.isTemplate;    //是否是从模板新建而来，true,是从模板新建表单；false，直接新建模板；""，表示没有传该参数
var pstrUserFunction="" //保存当前表单的自定义函数的内容
var pstrAddHtml="" //保存当前表单的附加页面元素的内容
var pstrSplitAddHtml= "<p id=splitaddhtml />" ;
var blnChange=false //改动标志,为真表示改动了要提示保存
var curSelElement =null //
var strXml;
var strID;
var arrtmp1=new Array();
var eform_class= 0;
var creator_remark = ""; //表单备注
var hasWorkflowButton = 0;        //表单是否含有工作流控制功能，0，没有；1，有
var islog = 0;           //是否记录表单日志
var isprotect = 0;       //是否进行页面保护
//控件名称数组
//var ArrName=getControlNameArr()
	var ArrName=new Array();
	ArrName[0]="SKButton";
	ArrName[1]="SKDBedit";
	ArrName[2]="checkbox";
	ArrName[3]="label";
	ArrName[4]="radio" ;
	ArrName[5]="listbox"
	ArrName[6]="textarea"
	ArrName[7]="combobox"
	ArrName[8]="password" ;
	ArrName[9]="upload" ;
	ArrName[10]="SKDBtext";
	ArrName[11]="chart";
	ArrName[12]="dbimg";
	ArrName[13]="img";
	ArrName[14]="SKBILLgrid";
	ArrName[15]="shape";
	ArrName[16]="tab";
	ArrName[17]="div";
	ArrName[18]="DsMain_field";  // SKDBTreeView改为DsMain_field,用来记录最大号
	ArrName[19]="a" ;
	ArrName[20]="button" ;
	ArrName[21]="text" 
	ArrName[22]="hr" ;
	ArrName[23]="checkboxlist"
	ArrName[24]="radiolist"
	ArrName[25]="dropdownlist"
	ArrName[26]="grid"
	ArrName[27]="dataset"
	ArrName[28]="spin"
	ArrName[29]="excel"
	ArrName[30]="tree"
	ArrName[31]="ebshow"; //显示e表控件
	ArrName[32]="creatorSubForm";
	ArrName[33]="creator_div";
	ArrName[34]="ExtGrid";
	ArrName[35]="ExtUpload";
	ArrName[36]="ExtTree";
	ArrName[37]="Fusionchar";
	//ArrName[28]="ep_borderstyle"

var oContXml = SetDom("<root></root>"); //保存每个控件ID

var ArrNum=new Array(); //保存每种控件的最大号
//var ArrCom = new Array(new Array()) ; //保存每个控件ID
InitControlNo()
/**
初始化控件数组
**/
function InitControlNo(){
	for(var Num=0;Num<ArrName.length;Num++){
		ArrNum[ArrName[Num]]=0;
		//ArrCom[ArrName[Num]] = new Array() ;
	}

}

//add by zzy
//初始化dataset
function init_dataset(){
	parent.objlist.execScript("init_objlist()");
}

/**
*窗体装入事件代码
**/
function window_onload() {

	eform_class=parent.Request.QueryString("eform_class").toString(); //表单类别
	if(eform_class =="undefined") eform_class=0;
	SKbillsheet.creatorType = eform_class;
	
	editor = new HTMLArea();
	editor._doc = document;
	editortab = new TableOperations() ;	
	
	var sHtml=GetBillType(); //读取billtype.xml中的记录.
	var my_sHtml = sHtml.substring(sHtml.indexOf('value=')+7,sHtml.indexOf('value=')+9);
	SKbillsheet.type = my_sHtml;

//setLinkSrc( "luna" )
  //  SKbillsheet.unselectable = "on";
    SKbillsheet.contentEditable=true
//    SKbillsheet.designMode="On"
	//SKbillsheet.ATOMICSELECTION=true
    document.execCommand("2D-Position", true, true);
    document.execCommand("MultipleSelection", true, true);
  
  SKbillsheet.focus() ;
  //为了支持一进入设计界面时就以设计模式打开某张表单
  if(isSpace(parent.topdjid) == false)//有djid的情况
  {
		var sdjid=parent.topdjid;
		fcpubdata.djid=sdjid;
		var sql="select djsn from FC_BILLZL where djid='"+sdjid+"'";
		//CopyToPub(sql)
		parent.topdjsn=SqlToField(sql);//通过ID设置DJSN
		SKbillsheet.dj_sn=parent.topdjsn;
		//alert(sql);
		//alert(parent.topdjsn);
		//alert(SKbillsheet.dj_sn);
		//CopyToPub(sdjid)
		DesignDjOpen(sdjid)
		//为了快速重新保存一下多个表单
		if(parent.Request.QueryString("resave").toString() == "yes"){
			SKbillsheet.contxml = "";
			oContXml = null ;
			DesignDjSave("不提示","是");
	  }  
	}
  else if(isSpace(parent.topdjsn) == false){
        //alert("enter this");
		var sql="select djid from FC_BILLZL where djsn='"+parent.topdjsn+"'";
		//alert("sql:"+sql);
		//CopyToPub(sql)
		var sdjid=SqlToField(sql);
		//CopyToPub(sdjid)
		//alert("sdjid:"+sdjid);
		DesignDjOpen(sdjid)
		//为了快速重新保存一下多个表单
		if(parent.Request.QueryString("resave").toString() == "yes"){
			SKbillsheet.contxml = "";
			oContXml = null ;
			DesignDjSave("不提示","是");
		}
  }else if(parent.Request.QueryString("ebuse").toString() == "yes"){ //e表用
		e_opendj();
  }else{
		//yes/no 用来决定是否是加控件时自动加字段
		fcpubvar.AutoAddField = parent.Request.QueryString("autoaddfield").toString();		
		AutoAddDsMain();
		var startpage = "" ;
		startpage = parent.Request.QueryString("startpage").toString();
		if(startpage != "no" ){
			//起始页
			//DjOpen("fcs_origPage",parent,"展现","有模式窗口","直接","起始页");
		}		
  }
  
  
	window_onresize();
	if(parent.menu.pubPositionChange == "是"){
		fcpubdata.position="absolute";
	}
	
	if(isTemplate=="true"){//表示是从模板新建表单,清除模板的djsn,djid和名称。
		SKbillsheet.caption="";		
		SKbillsheet.dj_sn = "";
		SKbillsheet.djid = "";
	}
	
	//布局新建
	var pageWidth=parent.Request.QueryString("pageWidth").toString();
	var pageHeight=parent.Request.QueryString("pageHeight").toString();
	
	if(!isNaN(pageWidth) && !isNaN(pageHeight)){
	 SKbillsheet.poswidth=pageWidth;
	 SKbillsheet.posheight=pageHeight;
	}
	
	init_dataset();
}
function window_onclick() {
	var obj = event.srcElement ;
	var sid = event.srcElement.id ;
	if(sid=="mainbody" || sid == "bigmain" || sid == "middlediv" || sid == "SKbillsheet" ){
		curSelElement=null ;
	}else if(obj.tagName == "TD") {
		try {
			var oP = obj.parentNode.parentNode.parentNode.parentNode ;
			if(oP.controltype == "tab") {
				curSelElement=null ;
				return ;
			}
		}catch(e){} ;
		curSelElement = event.srcElement;
	}
	

}
function resize() {
	ActMoveResize()
}

function move(){
	ActMoveResize()
}
/**
处理在页签控件上移动和调整控件时不能移到页签控件的外面
**/
function ActMoveResize() {
	
   var o=event.srcElement
   if(o == null)return;
   var oP=o.parentNode
   if(oP.tagName=="DIV" && oP.id=="fcpagesub"){
		
		var opwidth=oP.parentNode.style.posWidth
		if(typeof opwidth == "undefined") opwidth=oP.offsetWidth
		var opheight=oP.style.posHeight
		if(typeof opheight == "undefined") opheight=oP.offsetHeight
		
		if(o.offsetWidth>opwidth){
			o.style.width=opwidth
		}
		if(o.offsetHeight>opheight){
			o.style.height=opheight
		}
		if( o.offsetTop>opheight-o.offsetHeight){
		   //window.status="up:"+o.offsetTop
		  // event.returnValue=false
		  o.style.top=opheight-o.offsetHeight  //oP.offsetHeight-5
			
		}
		if(o.offsetLeft>opwidth-o.offsetWidth){
		  o.style.left=opwidth-o.offsetWidth //oP.offsetWidth-5
		
		}
		if(o.offsetTop<0){
			o.style.top=0
		}
		if(o.offsetLeft<0){
			o.style.left=0
		}
   }
   blnChange=true

}
/**
*当控件选择时给当前控件的全局变量
**/

function controlselect() {
	if(event.srcElement.id =="fcpagesubtable") {
		event.returnValue = false;
		return ;
	}
	curSelElement=event.srcElement ;
}
function controlselectcancel() {
	event.returnValue=false
}
/**
打开表单时调用
**/
function pageonload(){
	var oNode = oContXml.documentElement.selectSingleNode("tab") ;
	if(oNode != null ){
		var l=oNode.childNodes.length;
		for(var i=0;i<l;i++){
			var obj = eval(oNode.childNodes(i).text)
			
			//隐藏其它页的select控件
			var oPP=obj;
			var ll=oPP.childNodes.length;
			for(var ii=2;ii<ll;ii++){
				HideListBox(oPP.childNodes(ii),"是")
			}
			//try{
				HideListBox(oPP.childNodes(1),"否")		
			//}catch(E){}
		}			
	}
}
function CancelEvent(){
	if(event.srcElement.id=="fcpagesub" || event.srcElement.id=="fcpagesubtable" )
		event.returnValue=false;
}
function page_onresize(){

//调整子页的大小和页面控件同步
	var obj=event.srcElement
	var l=obj.childNodes.length
	var iWidth=obj.style.posWidth-2
	var iHeight=obj.style.posHeight-20
	if(iHeight<0){
		iHeight=0;
		obj.style.height=20;
	}
	for(var i=1;i<l;i++){
		obj.childNodes(i).style.posWidth=iWidth
		obj.childNodes(i).style.posHeight=iHeight
	}
}
function pageonclick() {
	//alert("dddd")
	var obj=event.srcElement
	//alert(obj.tagName)
	if(obj.tagName=="FONT") obj=obj.parentNode
	if(obj.tagName=="TD"){
		var index=obj.cellIndex
		var oTr=obj.parentNode
		var oP=oTr.parentNode.parentNode //table
		var oPP=oP.parentNode  //整个页签控件
		var l=oPP.childNodes.length;
		for(var i=1;i<l;i++){
			oPP.childNodes(i).style.zIndex=0
			//oPP.childNodes(i).style.display="none"

			oTr.cells(i-1).style.color="black"
			HideListBox(oPP.childNodes(i),"是")
		}
			oPP.childNodes(index+1).style.zIndex=1
			//oPP.childNodes(index+1).style.display="block"
			oTr.cells(index).style.color="red"
			HideListBox(oPP.childNodes(index+1),"否")
	}	
	/*
	if(obj.tagName=="A"){
		var oP=obj.parentNode.parentNode
	}else{
		var oP=obj.parentNode
	}
	var oPP=oP.parentNode  //整个页签控件
	var l=oPP.childNodes.length;
	for(var i=1;i<l;i++){
		oPP.childNodes(i).style.zIndex=0
	}
		oPP.childNodes(index).style.zIndex=1

	var oControlRange = document.body.createControlRange()  ;
	oControlRange.add(oPP.childNodes(index)) ;
	oControlRange.select() ;
	*/	

}
/**
* 换页时隐藏select控件
**/
function HideListBox(oPage,sTag){
	var sTag1
	var oList=oPage.all.tags("select")
	
	var l=oList.length
	if(sTag=="是"){
		for(var i=0;i<l;i++){
			if(oList(i).style.posWidth>0){
				oList(i).backwidth=oList(i).style.posWidth
				oList(i).backheight=oList(i).style.posHeight
				oList(i).style.posWidth=0
				oList(i).style.posHeight=0
			}
		}
	}else{
		for(var i=0;i<l;i++){
			if(isSpace(oList(i).backwidth)==false){
				oList(i).style.width=oList(i).backwidth
				oList(i).style.height=oList(i).backheight
			}
		}
	
	}

}



/**
	点击焦点次序时把界面上的所有的控件ID拼成XML串
	@date 2004-07-13
	@return 返回XML串"<root><taborder>SKButton1</taborder><taborder>SKButton2</taborder><root>"
**/		
function TaborderXml(){
	var l
	var l1
	var arrC=new Array()
	//下列控件有焦点
	arrC[0]=ArrName[0]
	arrC[1]=ArrName[1]
	arrC[2]=ArrName[2]
	arrC[3]=ArrName[4]
	arrC[4]=ArrName[5]
	arrC[5]=ArrName[6]
	arrC[6]=ArrName[7]
	arrC[7]=ArrName[14]
	arrC[8]=ArrName[20]
	arrC[9]=ArrName[21]
	arrC[10]=ArrName[25]
	arrC[11]=ArrName[26]
	arrC[12]=ArrName[28]
	if(isSpace(SKbillsheet.billtaborder)){
		strID="<root>";
		l=arrC.length
		for (var ilen=0;ilen<l;ilen++){
			var oNode = oContXml.documentElement.selectSingleNode(arrC[ilen])
			if( oNode  == null ) continue ;
			l1=oNode.childNodes.length
			for(var k=0;k<l1;k++){
				strID=strID+"<taborder>"+oNode.childNodes(k).text+"</taborder>";
			}
			/*
			l1=ArrNum[arrC[ilen]]
			for(var k=1;k<=l1;k++){
				try{
					obj=eval(arrC[ilen]+k);
					strID=strID+"<taborder>"+arrC[ilen]+k+"</taborder>";
				}catch(e){
					sfind="<taborder>"+arrC[ilen]+k+"</taborder>";
					if(strID.indexOf(sfind)>0){
						strID=RepStr(strID,sfind,"");
					}
				}
			}*/
		}
		strID=strID+"</root>";
	}else{
		//先去掉在taborder中存在而在oContXml中不存在的控件
		var sxml = SKbillsheet.billtaborder ;
		var oX = SetDom(sxml) ;
		var l = oX.documentElement.childNodes.length ;
		for(var i=l-1;i>=0;i--){
			var oNode = oContXml.documentElement.selectSingleNode("//id[. ='"+oX.documentElement.childNodes(i).text+"']") ;
			if( oNode  == null ) {
				oX.documentElement.removeChild(oX.documentElement.childNodes(i));
			}
		}
		sxml=oX.documentElement.xml ;
		//加上新的控件
		strID=RemoveRoot(sxml);
		l=arrC.length
		for (var ilen=0;ilen<l;ilen++){
			var oNode = oContXml.documentElement.selectSingleNode(arrC[ilen])
			if( oNode  == null ) continue ;
			l1=oNode.childNodes.length
			for(var k=0;k<l1;k++){
				var sfind = "<taborder>"+oNode.childNodes(k).text+"</taborder>";
				//如不存在,则加上
				if(strID.indexOf(sfind)<0){ 
					strID=strID+sfind
				}
			}
		
			/*
			l1=ArrNum[arrC[ilen]]
			for(var k=1;k<=l1;k++){
				try{
					obj=eval(arrC[ilen]+k);
					sfind="<taborder>"+arrC[ilen]+k+"</taborder>";
					if(strID.indexOf(sfind)<0){
						strID=strID+sfind;
					}
				}catch(e){
					sfind="<taborder>"+arrC[ilen]+k+"</taborder>";
					if(strID.indexOf(sfind)>=0){
						strID=RepStr(strID,sfind,"");
					}
				}
			}
			*/
		}
		strID = "<root>" + strID + "</root>" ;
	}
	return strID;
}
/**
表单保存
   保存表单：
   	0 合法性检查，单据SN重名检查，
   	1 预处理控件，如将表单控件进行转换后得到新的大HTML串
   	2 创建临时表
   	3 根据djid决定是INSERT还是UPDATE，只保存FC_BILLZL表中的几个字段：djid djsn djposition xmlstr
   	
   	用一个存储过程来保存表单，
   	此过程做如下工作：
   	  1 检查单据SN是否重名，如重名则保存完后给出提示。
   	  2 创建临时表。根据前台传来的命令创建。
   	  3 根据djid决定是INSERT还是UPDATE,如为INSERT,则从FC_MAXBH表中查找biaoshi字段为BIL的记录的recnum字段+1后
   	    当作djid,同时将+1后的值给recnum字段.
   	    
   	    更新FC_BILLZL表中的djid,djsn,dj_name,djlx,djposition,xmltext,designtext,stmptable
	此过程的输入参数：
		djid,djsn,dj_name,djlx,djposition,xmltext,designtext,stmptable   	    

 * 保存表单时，生成运行串要处理：1 数据集控件 2 页签控件 3 各控件的事件（点击） 4 生成建临时表的串
 
 
 * 分保存到数据库和保存到文件
 notalert = "不提示" 表示保存成功后不提示
 nothtml="是" 表示不生成正式表单文件
 iseb = "是" 表示用于e表中的保存参数报表,此时返回一个所需要的结果数组.

*@date 2004-07-21
**/
function DesignDjSave(notalert,nothtml,iseb){		
	if(isTemplate=="true"){ //表示从模板新建表单
		curdjid=0;  //表示保存的时候要重新生成id。
		saveAsTemplate = 0; //为0，代表保存为表单，默认值也为0
		SKbillsheet.creatorType = eform_class;   //将表单类别赋值。
	}else if(isTemplate == "false"){  //表示直接在模板管理中新增模板
		curdjid=0;  //表示保存的时候要重新生成id。
		saveAsTemplate = 1; //为1，代表保存为模板，默认值为0		
	}
	if(iseb != "是"){
	//存盘前检查
	//djid和dj_sn改由系统确定，故去掉验证 但表单名称（dj_name）还是需要用户输入，故还是得加上dj_name的验证，否则会有错误。		
		if(isSpace(SKbillsheet.caption)){
			var s1 = '表单名称不能为空!请进入表单属性窗口输入表单名称.'
			alert(s1) ;
			var arrForm=new Array();
			arrForm[0]=SKbillsheet;
			arrForm[5]=pstrUserFunction;
			s1 = DjOpen('form',arrForm,'展现',"有模式窗口","直接","表单属性") ;
			return s1
		}
		oContXmlTMP = SetDom(SKbillsheet.contxml);
		var extoNode = oContXml.documentElement.selectSingleNode("ExtTree") ;
		if(extoNode != null ){
			for(var i=0;i<extoNode.childNodes.length;i++){
				var obj = eval(extoNode.childNodes(i).text);
				//alert(obj.treeRule);
				//alert(typeof(obj.treeRule));
				if(typeof(obj.treeRule)=='undefined'){
					var s1 = "没有对"+extoNode.childNodes(i).text+"进行配置";
					alert(s1);
					return s1;
				}
			}
		}
	}
	
    //var desinghtml=SKbillsheet.outerHTML;
	//对grid的分页按钮进行控制

	/*
	var creator_pagination_str = SKbillsheet.creator_pagination;
	alert(creator_pagination_str);
	if(!IsSpace(creator_pagination_str)){
		var outhtmltemp = SKbillsheet.outerHTML;
		var reg = /<IMG id=(\w+)\s*.*\s*controltype=\"grid\">/ig;
		var r = "";  
		var grid_id = "";  
		while(r = reg.exec(outhtmltemp)) 
		{    
			grid_id = r[1];
		    alert(r[0] + "  " + r[1]);    
		}
		alert($(grid_id).style);
		
		while(outhtmltemp.indexOf("<IMG id=grid")!=-1){
			var divStyle = outhtmltemp.substring(outhtmltemp.indexOf("<IMG id=grid"));
			var gridstr = divStyle.substring(divStyle.indexOf("grid"));
			var gridid = gridstr.substring(0,gridstr.indexOf(" "));
			divStyle = divStyle.substring(0,divStyle.indexOf(">")+1);
			divStyle = divStyle.substring(divStyle.indexOf("style=\"")+7);
			divStyle = divStyle.substring(0,divStyle.indexOf("\""));
			var arr = divStyle.split(";");
			if(arr.length == 5){
				var top = arr[3].substring(arr[3].indexOf("TOP:")+5,arr[3].indexOf("px"));
				var height = arr[4].substring(arr[4].indexOf("HEIGHT:")+7,arr[4].indexOf("px"));
				var num=(top-1)+(height-1)+12;
				divStyle = "style=\""+arr[0]+"; "+arr[1]+"; "+arr[2]+"; TOP: "+num+"; HEIGHT: 50px\"";
			}

			var replacePrefix = '<div name=Ctrl'+gridid+' '+divStyle+'><input type="button" id=firstpage'+gridid+' onclick=\"buttonevent(\''+gridid+'\',\'firstpage\')\" value="首页"/><input type="button" id=prevpage'+gridid+' onclick=\"buttonevent(\''+gridid+'\',\'prevpage\')\" value="上一页"/><input type="button" id=nextpage'+gridid+' onclick=\"buttonevent(\''+gridid+'\',\'nextpage\')\" value="下一页"/><input type="button" id=lastpage'+gridid+' onclick=\"buttonevent(\''+gridid+'\',\'lastpage\')\" value="尾页"/><button type="button" value="" style="border:none;background-color:#FFFFFF""><div id=pageInfo'+gridid+'></div></button></div>';
			var namevalue="Ctrl"+gridid;
			var mystr = "name="+"\""+namevalue+"\"";
			//如果同一个grid存放button的层不存在，则生成层
		 	if(creator_pagination_str!=undefined){
				var strtemp = creator_pagination_str.split(";");
		        	for(var i = 0;i<strtemp.length;i++){
		        		var strtemp1 = strtemp[i].split(",");  
		        		if(strtemp1[2]!="" && strtemp1[0]==gridid){
			      			if(outhtmltemp.indexOf(mystr)==-1){
								SKbillsheet.outerHTML = SKbillsheet.outerHTML.replace("<IMG id="+gridid,replacePrefix+"<IMG id="+gridid);
				  			}
		       			}
		    		}
			}
			outhtmltemp = outhtmltemp.substring(outhtmltemp.indexOf("<IMG id=grid")+10);
		}
	}
	*/

	//sxb 20080912 生成分页控件
	//var creator_pagination_str = SKbillsheet.creator_pagination;
	//if(!IsSpace(creator_pagination_str)){
		var outhtmltemp = SKbillsheet.outerHTML;
		var reg = /<IMG id=(\w+)[^<]*controltype=\"grid\"[^<]*>/ig;
		var r = "";
		var gridid = "";  
		//先清空，然后再保存
		SKbillsheet.creator_pagination="";
		while(r = reg.exec(outhtmltemp)) 
		{    
			gridid = r[1];			
		    if($(gridid)&&$(gridid).ispage=="是")
		    {
		    	if(IsSpace($(gridid).pagesize))
		    	{
		    		$(gridid).pagesize=10;
		    	}
		    	//sxb 设置dataset的pagesize属性 20080917
		    	$($(gridid).dataset).PageSize = $(gridid).pagesize;
			    var left = "LEFT:"+$(gridid).style.left;
			    var width = "WIDTH:"+$(gridid).style.width;
			    var position = "POSITION:"+$(gridid).style.position;
				var top = $(gridid).style.top;
				var height = $(gridid).style.height;
				var num=(top.replace("px","")-1)+(height.replace("px","")-1)+12;
				//modified by zhou.luo 2008-11-04 为每个button添加在鼠标移上去的时候变手型,同时修改分页信息的展示的背景为透明
				//var divStyle = "style=\""+left+"; "+width+"; "+position+"; TOP: "+num+"; HEIGHT: 50px\"";
				//var replacePrefix = '<div name=Ctrl'+gridid+' '+divStyle+'><input type="button" id=firstpage'+gridid+' onclick=\"buttonevent(\''+gridid+'\',\'firstpage\')\" value="首页"/><input type="button" id=prevpage'+gridid+' onclick=\"buttonevent(\''+gridid+'\',\'prevpage\')\" value="上一页"/><input type="button" id=nextpage'+gridid+' onclick=\"buttonevent(\''+gridid+'\',\'nextpage\')\" value="下一页"/><input type="button" id=lastpage'+gridid+' onclick=\"buttonevent(\''+gridid+'\',\'lastpage\')\" value="尾页"/><button type="button" value="" style="border:none;background-color:#FFFFFF""><div id=pageInfo'+gridid+'></div></button></div>';
                //var replacePrefix = '<div name=Ctrl'+gridid+' '+divStyle+'><input type="button" id=firstpage'+gridid+' style="cursor:hand" onclick=\"buttonevent(\''+gridid+'\',\'firstpage\')\" value="首页"/><input type="button" id=prevpage'+gridid+' style="cursor:hand" onclick=\"buttonevent(\''+gridid+'\',\'prevpage\')\" value="上一页"/><input type="button" id=nextpage'+gridid+' style="cursor:hand" onclick=\"buttonevent(\''+gridid+'\',\'nextpage\')\" value="下一页"/><input type="button" id=lastpage'+gridid+' style="cursor:hand" onclick=\"buttonevent(\''+gridid+'\',\'lastpage\')\" value="尾页"/><button type="button" value="" style="border:none;background-color:#FFFFFF"><div id=pageInfo'+gridid+'></div></button></div>';
				
				var divStyle = "style=\"BORDER-RIGHT: 0px; BORDER-TOP: 0px; OVERFLOW: auto; BORDER-LEFT: 0px; BORDER-BOTTOM: 0px; "+left+"; "+width+"; "+position+"; TOP: "+num+"; HEIGHT: 34px\"";
				var replacePrefix = '<DIV name=Ctrl'+gridid+' '+divStyle+'onmove=move() oncontrolselect=controlselect() onresizeend=resizeEnd() onresizestart=resizeStart() onmoveend=moveEnd() onresize=resize() onmovestart=moveStart() NotBg="是" controltype="div">'
				+'<BUTTON onmove=move() oncontrolselect=controlselect() id=firstpage'+gridid+' fc_onclick=\"bill_onclick(&quot;buttonevent(\''+gridid+'\',\'firstpage\')&quot;)\" onresizeend=resizeEnd() onresizestart=resizeStart() onmoveend=moveEnd() onresize=resize() style="LEFT: 1px; WIDTH: 60px; CURSOR: hand; POSITION: absolute; TOP: 3px; HEIGHT: 21px" onmovestart=moveStart() controltype="button" dropstyle="否">首页</BUTTON>'
				+'<BUTTON onmove=move() oncontrolselect=controlselect() id=prevpage'+gridid+' fc_onclick=\"bill_onclick(&quot;buttonevent(\''+gridid+'\',\'prevpage\')&quot;)\" onresizeend=resizeEnd() onresizestart=resizeStart() onmoveend=moveEnd() onresize=resize() style="LEFT: 62px; WIDTH: 60px; CURSOR: hand; POSITION: absolute; TOP: 3px; HEIGHT: 21px" onmovestart=moveStart() controltype="button" dropstyle="否">上一页</BUTTON>'
				+'<BUTTON onmove=move() oncontrolselect=controlselect() id=nextpage'+gridid+' fc_onclick=\"bill_onclick(&quot;buttonevent(\''+gridid+'\',\'nextpage\')&quot;)\" onresizeend=resizeEnd() onresizestart=resizeStart() onmoveend=moveEnd() onresize=resize() style="LEFT: 123px; WIDTH: 60px; CURSOR: hand; POSITION: absolute; TOP: 3px; HEIGHT: 21px" onmovestart=moveStart() controltype="button" dropstyle="否">下一页</BUTTON>'
				+'<BUTTON onmove=move() oncontrolselect=controlselect() id=lastpage'+gridid+' fc_onclick=\"bill_onclick(&quot;buttonevent(\''+gridid+'\',\'lastpage\')&quot;)\" onresizeend=resizeEnd() onresizestart=resizeStart() onmoveend=moveEnd() onresize=resize() style="LEFT: 184px; WIDTH: 60px; CURSOR: hand; POSITION: absolute; TOP: 3px; HEIGHT: 21px" onmovestart=moveStart() controltype="button" dropstyle="否">尾页</BUTTON>' 
                +'<DIV id=pageInfo'+gridid+' style="BORDER-RIGHT: 0px; BORDER-TOP: 0px; FONT-WEIGHT: normal; FONT-SIZE: 14px; LEFT: 249px; BORDER-LEFT: 0px; WIDTH: 80px; LINE-HEIGHT: normal; BORDER-BOTTOM: 0px; FONT-STYLE: normal; POSITION: absolute; TOP: 6px; HEIGHT: 19px; FONT-VARIANT: normal" NotBg="否"></DIV></DIV>';
				
				var namevalue="Ctrl"+gridid;
				var mystr = "name="+"\""+namevalue+"\"";
			 	if(outhtmltemp.indexOf(namevalue)==-1)
			 	{
					SKbillsheet.outerHTML = SKbillsheet.outerHTML.replace("<IMG id="+gridid,replacePrefix+"<IMG id="+gridid);
				}
			}
			SKbillsheet.creator_pagination += gridid+","+$(gridid).dataset+","+$(gridid).pagesize+";";
		}		
	//}
	///////////////////////////////
	
	//sxb 20081022 如果表单引用选择了不自动加载，去掉src的值
	clearIframesSrcs();
	//

	
	//维护控件ID
	if(TooContXml()){ 
		openobjlist(); 
	}else{
		return "no empty";
	}
	//
	
		var d=new Date()
		var t = d.getTime();
	if(iseb != "是"){

		//保存 44,84,709,453,居中,不带工具栏,修改,当前窗口,有文件
		var sdjposition=""
		if(IsSpace(SKbillsheet.posleft)){
			sdjposition+=window.screenLeft+","
		}else{
			sdjposition+=SKbillsheet.posleft+","
		}
		if(IsSpace(SKbillsheet.postop)){
			sdjposition+=window.screenTop+","
		}else{
			sdjposition+=SKbillsheet.postop+","
		}
		if(IsSpace(SKbillsheet.poswidth)){
			sdjposition+=window.document.body.clientWidth+","
		}else{
			sdjposition+=SKbillsheet.poswidth+","
		}
		if(IsSpace(SKbillsheet.posheight)){
			sdjposition+=window.document.body.clientHeight+","
		}else{
			sdjposition+=SKbillsheet.posheight+","
		}
		sdjposition+=SKbillsheet.center+","
		sdjposition+=SKbillsheet.toolbar+","
		sdjposition+=SKbillsheet.entertype+","
		sdjposition+=SKbillsheet.window
	}
	var scontrolno=SaveControlNo()
	SKbillsheet.controlno=scontrolno
	//如和下一个ID
	
	//保存控件名称的DOM串
	SKbillsheet.contxml=oContXml.documentElement.xml
	
	//alert(SKbillsheet.contxml);
	
	//将表单中的控件的类型和id和控件的xml串解析出来。
	var controlManager = "";
	/*
	var allObj = SKbillsheet.all;
	for(var i = 0;i < allObj.length; i++){
		var control_id = allObj[i].id;
		var control_type = allObj[i].controltype;		
		var control_xml = allObj[i].outerHTML;
		if(typeof(control_id) == "undefined" || typeof(control_type) == "undefined" ){ 
		    continue;
		}
		//if(control_type=="gaEditor" || control_type=="WebOffice" || control_type=="upload"){
		controlManager = controlManager + control_type + "PSeparator" + control_id + "PSeparator" + control_xml+ "LSeparator";
		//}
	}
	controlManager = controlManager.substring(0,controlManager.length-10);
	controlManager = "<![CDATA["+TransSql(controlManager)+"]]>";
	*/
	
	//获得所有数据集的id
	var ds_ids = "";    //所有数据集的数组。
	var oNode = oContXml.documentElement.selectSingleNode("dataset");
	if(oNode!=null){
		var l = oNode.childNodes.length;
		for(var i = 0;i < l;i++){						
			ds_ids = ds_ids + oNode.childNodes(i).text + ",";
		}
		if(l>0){
			ds_ids = ds_ids.substring(0,ds_ids.length-1);
		}
	}
	
    //added by zhou.luo 2008-10-18 获取所有tab控件的每个页签里面包含的gridid。
    //modified by zhou.luo 2008-10-22 获取所有tab控件的每个页签里面包含的引用控件(iframe).
    var creator_tab = "";
    var oTabNode = oContXml.documentElement.selectSingleNode("tab");
    if(oTabNode!=null){
        var l = oTabNode.childNodes.length;
        for(var i = 0;i < l;i++){
            creator_tab += oTabNode.childNodes(i).text + ",";  
        }
        if(l>0){
            creator_tab = creator_tab.substring(0,creator_tab.length-1);
        }   
    }
    //alert("creator_tab:"+creator_tab);
    if(creator_tab!=""){
	    var arrTab = creator_tab.split(",");
	    var allTab = "";
	    for(var j = 0; j < arrTab.length;j++){
	        var oTab = eval(arrTab[j]);        
	        var sTab = "";
	        var tabContents = "";
	        for(var k = 1; k < oTab.childNodes.length;k++){ //第一个儿子节点为一个table存放有几个页签，这里不需要解析，后面一个div表示一个页签。            
	            var sTabContent = "";
	            var oTabChild = oTab.childNodes[k];
	            var regTab = /<IMG id=(\w+)[^<]*controltype=\"grid\"[^<]*>/ig;
	            var regIframe = /<IFRAME id=(\w+)[^<]*controltype=\"creatorSubForm\"[^<]*>/ig; 
	            var sGridid = "";
	            var sIframeid = "";
	            var tabGridid = null;
	            var tabIframeid = null;
	            while(tabGridid = regTab.exec(oTabChild.innerHTML)){
	                sGridid += tabGridid[1] + ",";
	            }
	            while(tabIframeid = regIframe.exec(oTabChild.innerHTML)){
	                sIframeid += tabIframeid[1] + ",";
	            }            
	            if(sGridid!=""){
	            	sGridid = sGridid.substring(0,sGridid.length-1);
	            	sGridid = "<gridid>"+sGridid+"</gridid>";	            	
	            }else{
	                sGridid = "<gridid></gridid>";
	            }
	            if(sIframeid!=""){
	                sIframeid = sIframeid.substring(0,sIframeid.length-1);
	                sIframeid = "<iframeid>"+sIframeid+"</iframeid>"
	            }else{
	                sIframeid = "<iframeid></iframeid>";
	            }
	            sTabContent = "<index>"+(k-1)+"</index>" + sGridid + sIframeid;            
	            if(sTabContent!=""){
	            	tabContents += sTabContent;
	            }
	        }
	        if(tabContents!=""){
	            sTab = "<tab><id>"+arrTab[j]+"</id><content>"+tabContents+"</content></tab>";
	            allTab += sTab;
	        }
	    }
	    allTab = "<tabs>"+allTab+"</tabs>";
	    //alert("allTab:"+allTab);
	    SKbillsheet.creator_allTab = allTab;
	}
	
	/* 得到从数据集的个数。
	var SKbillHtml = SKbillsheet.outerHTML;
	var myDsSub = new Array();     //从数据集的数组。
	oNode = oContXml.documentElement.selectSingleNode("grid");
	if(oNode!=null){
		var l = oNode.childNodes.length;
		var j = 0;
		for(var i = 0;i < l;i++){						
			var gridId = oNode.childNodes(i).text;
			var gridXml = SKbillHtml.substring(SKbillHtml.indexOf("<IMG id="+gridId));
			gridXml = gridXml.substring(0,gridXml.indexOf(">"));			
			if(gridXml.indexOf("dataset")!=-1){	
				var gds = gridXml.substring(gridXml.indexOf("dataset=")+9);			  
			    gds = gds.substring(0,gds.indexOf("\""));	
			    var k = 0;
			    for(k = 0;k<j;k++){
			    	if(gds==myDsSub[k]){//grid绑定的数据集相同。不放到数组myDsSub中去。
			    		break;
			    	}
			    }
			    if(k==j){
			    	myDsSub[j] = gds;
			    	j++;
			    }		    
			}
		}		
	}
	
	var myDsMain = new Array();    //所有数据集的数组。
	var oNode = oContXml.documentElement.selectSingleNode("dataset");
	if(oNode!=null){
		var l = oNode.childNodes.length;
		for(var i = 0;i < l;i++){						
			myDsMain[i] = oNode.childNodes(i).text;
		}
	}
	
	alert("myDsMain:"+myDsMain.length);
	for(var i = 0;i < myDsMain.length;i++){
		alert("myDsMain["+i+"]="+myDsMain[i]);
	}
	alert("myDsSub:"+myDsSub.length);
	if(myDsMain.length-myDsSub.length>1){
		alert("一个表单只能有一个主数据集，该表单有多个主数据集，保存之前必须指定保存哪个主数据集！");
	}
	*/
	
	
	
	
	
	//为表单添加BLONopen属性。用于打开事件，默认权限控制。加精！！！
	if(IsSpace(SKbillsheet.BLONopen)){
	    SKbillsheet.BLONopen = "setAuthority();";
	}
	
	//获取表单备注，没有就为空
	if(IsSpace(SKbillsheet.creator_remark)){
		creator_remark = "";
	}else{
		creator_remark = SKbillsheet.creator_remark;
	}
	
	//获取表单是否包含工作流控制功能。
	if(IsSpace(SKbillsheet.hasWorkflowButton)){
	    hasWorkflowButton = 0;
	}else{
		if(SKbillsheet.hasWorkflowButton=='是'){
			hasWorkflowButton = 1;
		}else if(SKbillsheet.hasWorkflowButton=='否'){
			hasWorkflowButton = 0;
		}
	}
	
	//获取表单是否记录日志
	if(IsSpace(SKbillsheet.islog)){
	    islog = 0;
	}else{
		if(SKbillsheet.islog=='是'){
			islog = 1;
		}else if(SKbillsheet.islog=='否'){
			islog = 0;
		}
	}
	//获取表单是否进行页面保护
	if(IsSpace(SKbillsheet.isprotect)){
	    isprotect = 0;
	}else{
		if(SKbillsheet.isprotect=='是'){
			isprotect = 1;
		}else if(SKbillsheet.isprotect=='否'){
			isprotect = 0;
		}
	}
	
	DesignStr_RunStr_Before(SKbillsheet)
	
	var sDesignText = SKbillsheet.outerHTML; //保存好设计串

	var sDesignTextBak = sDesignText ;


	
	//附加页面
	var tmpaddhtml=""
	if(pstrAddHtml != ""){
		tmpaddhtml=pstrSplitAddHtml+pstrAddHtml
	}
	if(iseb != "是"){

		//如果是保存到文件,在我们这个系统里面全部都是保存到数据库。
		if (SKbillsheet.isfile == "是") {			
			sDesignText="<![CDATA[<script>"+RepStr(pstrUserFunction,"\r\n","&#13;&#10;")+"</scr"+"ipt> "+sDesignText+tmpaddhtml+"]]>"
	//		var sFile = trim(SKbillsheet.type)+"_"+trim(SKbillsheet.dj_sn)
			var sFile = trim(SKbillsheet.dj_sn)
			var sXml = "<no>"+sFile+"</no><no>"+sDesignText+"</no><no></no>"+"<No>"+fcpubdata.Path+"</No>"
			var ret=savedesignhtml(sXml)
			if(ret == "") {
				if(notalert != "不提示") alert(sFile+".dj文件保存成功!") ;
				return "" ;
			}else{
				alert(ret)
				return ret
			}
			 
		}else{
			sDesignText="<![CDATA["+TransSql(sDesignText)+"]]>"
		
		}
	}
	
	SKbillsheet.removeAttribute("contentEditable")
	SKbillsheet.removeAttribute("unselectable")
	
	DesignStr_RunStr_Before0() ;
	//由设计转为运行串
	var sRun=SKbillsheet.outerHTML
	
	sRun = DesignStr_RunStr_After(sRun,ArrNum)
	if(iseb == "是"){ //e表保存 由此返回 
		return [sDesignTextBak,sRun,pstrUserFunction,pstrAddHtml];	
	}
	SKbillsheet.outerHTML = sDesignTextBak ;
    SKbillsheet.unselectable = "on";
    SKbillsheet.contentEditable=true

	//临时表	
	var stmptable=""
	if(isSpace(SKbillsheet.runsave)==false){
		stmptable=GetTmpTableStr() ;
		stmptable="<![CDATA["+TransSql(stmptable)+"]]>"
	}
	//自定义函数
	var tmpfunc=pstrUserFunction
	//tmpfunc=TransXml(tmpfunc) ;
	tmpfunc=TransSql(repNewLine(repXml(tmpfunc))) ;
	tmpaddhtml="<![CDATA["+TransSql(tmpaddhtml)+"]]>"
	
	sRun="<![CDATA["+TransSql(sRun)+"]]>"

	var sXml="<no>"+curdjid+"</no>"+"<no>"+SKbillsheet.dj_sn+"</no>"+"<no>"+SKbillsheet.caption+"</no>"+"<no>"+SKbillsheet.type+"</no>"
	         +"<no>"+sdjposition+"</no>"+"<no>"+sRun+"</no>"+"<no>"+sDesignText+"</no>"
	         +"<no>"+tmpfunc+"</no>"
	         +"<no>"+stmptable+"</no>"
			 +"<no>"+tmpaddhtml+"</no>"
			 +"<no>"+fcpubdata.databaseTypeName+"</no>"
			 +"<no>"+SKbillsheet.version+"</no>"       //为eform添加版本号
			 +"<no>"+SKbillsheet.creatorType+"</no>"   //表单类别
			 +"<no>"+saveAsTemplate+"</no>"            //是否保存为模板。	
			 +"<no>"+creator_remark+"</no>"            //表单备注	
			 +"<no>"+hasWorkflowButton+"</no>"		   //是否包含工作流控制功能			
			 +"<no>"+islog+"</no>"					   //是否保日志         
			 +"<no>"+isprotect+"</no>"                 //是否启用页面保护  
			 +"<no>"+ds_ids+"</no>"                    //所有数据集的数组
			 +"<no>"+controlManager+"</no>";           //需要管理起来的控件，格式："control_type,control_id;..."
			 				
	//CopyToPub(sXml)
	var sRet=designdjsave(sXml);
	var iPos=sRet.indexOf(",");
	var sMsg=sRet.substring(iPos+1,sRet.length);
 	//alert("返回值："+sRet);
    //alert("djid:"+curdjid);
    //alert("SKbillsheet.dj_sn:"+SKbillsheet.dj_sn);
    //alert(sXml);
    	
	if(isSpace(sMsg)==false){
		alert(sMsg)
		return sMsg
	}else{ // save ok
		if(curdjid == 0){
			var s=sRet.substring(0,iPos)
		}
		var s=sRet.substring(0,iPos);
		//modified in 2008-09-17 将djid改为number(20)后需要修改。
		//curdjid=parseInt(s);
		curdjid = s;
		SKbillsheet.dj_sn = curdjid;
		parent.topdjsn = curdjid	//给parnt.topdjsn赋值
		//alert(parent.topdjsn);
		
		ChangeWinTitle(SKbillsheet.dj_sn)
		//起始页
		try{
			var arr=new Array(4);
			var str="";
			str=LoadPubData("origPage");
			arr=str.split(";");
			//var oXml=new ActiveXObject("Microsoft.XMLDOM");
			//oXml.async=false;
			// oXml.loadXML (str) ;
			var s1=curdjid+","+SKbillsheet.dj_sn+","+SKbillsheet.caption;
			arr=moveArr(arr,s1);
			var str1="";
			for(var i=0;i<arr.length;i++){
				str1+=arr[i]+";"
			}
			str1=str1.substring(0,str1.length-1);
			SavePubData("origPage",str1);
		}catch(e){}
		//生成正式表单文件
		if(nothtml != "是") {
			//var tmpNo = SKbillsheet.dj_sn ;
			var tmpNo = SKbillsheet.djid ;
			var obj = BillTypeNameToPath(SKbillsheet.type);
			
			//var sPos=loadhtml("select djposition,dj_name from FC_BILLZL where djsn='"+tmpNo+"'",tmpNo,obj.path,obj.extname,function callback(){});
			//var sPos=loadhtml("select djposition,dj_name from FC_BILLZL where djid='"+curdjid+"'",curdjid,obj.path,obj.extname,function callback(){});
			var sPos=loadhtml("select djposition,dj_name from FC_BILLZL where djid='"+curdjid+"'",curdjid,fcpubdata.savePath,fcpubdata.extname,function callback(){});
		}
		
		isTemplate = "";  //保存成功后，不管是"true"还是"false"都要将isTempate清空。
		var tempSql="update TB_Form t set cssFolder='"+SKbillsheet.creatorStyle+"' where t.djid='"+curdjid+"'"
		InsertSql(tempSql);		
		if(notalert != "不提示") alert("保存成功！")
		return ""
	}
	function moveArr(arr,sValue){
		if(sValue!=""){
			if(arr[0]!=sValue && arr[1]!=sValue && arr[2]!=sValue && arr[3]!=sValue){
				arr[3]=arr[2];
				arr[2]=arr[1];
				arr[1]=arr[0];
				arr[0]=sValue;
			}else{
				if(arr[0]==sValue || arr[1]==sValue || arr[2]==sValue || arr[3]==sValue){
					var str="";
					for(var i=3;i>=0;i--){
						if(arr[i]==sValue){
							str=arr[i];
							for(var j=i;j>0;j--){
								arr[j]=arr[j-1];
							}
							arr[0]=str;
							break;
						}
					}
				}
			}
		}
		return arr;
	}
	/**
	得到要建的临时表的建表串
	*@date 2004-07-30
	**/
	function GetTmpTableStr(){
		//return ""
		var sRet="";
		var oNode = oContXml.documentElement.selectSingleNode("dataset");
		if(oNode != null) {
			var l = oNode.childNodes.length;
			for(var i=0;i<l;i++){
				var id = oNode.childNodes(i).text;
				var ods=eval(id);
				if(ods.iscreatetable=="是"){
					var sXml=ods.formatxml;
					//西文字段名0 中文名称1 字段类型2 字段宽度3 字段精度4 
					var stablename=ods.temptable;
					sRet+=GetCreateTable(stablename,sXml,true)+";" ;
					
				}			
			}
		}	
		if(sRet != "" ){
			sRet=sRet.substring(0,sRet.length-1);
		}
		return sRet;
		

	}
	
}
/**
打开表单
designtext字段中包含自定义函数的内容，但不含附加页面的内容。
自定义函数的内容在最前面。
*@date 2004-08-02
**/

function DesignDjOpen(djid){
	if(SaveTip() == true) return;
	if (djid<=0) return ""
    if(fcpubdata.databaseTypeName == "oracle"){
    	var sRet = loadClob("<no>designtext</no><no>"+djid+"</no>")
		//sRet = UnTransSql(sRet)   	
    }else{
	    
		var sql="select designtext from FC_BILLZL where djid="+djid ;
		var sRet=SqlToField(sql);
		if(isSpace(sRet)) return ""
	}
	var s = DesignDjOpenSub(sRet,djid);
	return s
}
function DesignDjOpenSub(sRet,djid) {
	//CopyToPub(sRet)
	//自定义函数+"</scr"+"ipt>"+表单画的内容+pstrSplitAddHtml+附加表单的内容
	if(typeof djid == "undefined") djid = 0
	if(typeof sRet == "object"){ //e表时用
		if(IsSpace(sRet[0]) == false){
			SKbillsheet.outerHTML=sRet[0];
		}
		//sRet[1] 为表单运行串
		pstrUserFunction = sRet[2];
		pstrAddHtml = sRet[3]
		
	}else{
		var iEnd=sRet.indexOf("</scr"+"ipt>") ;
		if(iEnd==-1){
			pstrUserFunction="";
			sHtm=sRet
		}else{
			var sHtm=sRet.substring(iEnd+9,sRet.length) ;
			if(isSpace(sHtm)){
				
				return ""
			} 
			pstrUserFunction=sRet.substring(8,iEnd) ;
			pstrUserFunction=unRepNewLine(unRepXml(pstrUserFunction));
		}
		//求 附加页面串
		var ipos=sHtm.indexOf(pstrSplitAddHtml)
		if(ipos==-1){
			pstrAddHtml=""
			
		}else{
			pstrAddHtml=sHtm.substring(ipos+pstrSplitAddHtml.length,sHtm.length)	
			sHtm=sHtm.substring(0,ipos)
		}
		SKbillsheet.outerHTML=sHtm //+pstrAddHtml ;
		SKbillsheet.creatorType = eform_class;
		//alert(SKbillsheet);
	}
	try{
		if(isSpace(SKbillsheet.controlno)) return "" ;
	}catch(e){
		//当sHtm不是合法的HTM串时出错
		if(isSpace(sHtm) == false){
			alert(sHtm); 
		}
		return "" ;
	}
	curdjid=djid ;

	ArrNum = OpenControlNo(SKbillsheet.controlno,ArrNum)
	var scontxml = SKbillsheet.contxml
	if(isSpace(scontxml)  ) {
		scontxml = "<root></root>"
	}
	oContXml=SetDom(scontxml)
	
	//处理控件列表
	openobjlist();
	ShowAllField();
	
	pageonload()
	ChangeWinTitle(SKbillsheet.dj_sn)
	bigmain.focus() ;
	//CopyToPub(bigmain.innerHTML)
	blnChange = false
	return "OK"
}

/**
新建表单,isWizard ="是" 表示有向导
*@date 2004-08-02
**/
function DesignDjNew(isWizard) {
	if(SaveTip() == true) return;
	if(isWizard == "是"){
		var sHtm = DjOpen('fcs_NewWizard',SKbillsheet,'展现',"有模式窗口","直接","新建表单向导");
		if(typeof sHtm == "undefined") return ;
	}else{
		var sHtm = "空" ;
	}
	if( sHtm == "空") {
		curdjid=0 ;
		pstrUserFunction=""
		pstrAddHtml=""
		SKbillsheet.outerHTML ='<div id="SKbillsheet" oncontrolselect="controlselect()" jslib="fcopendj.js&#13;&#10;fcsavedj.js&#13;&#10;fcselfuse.js&#13;&#10;fcbasecont.js&#13;&#10;fcother.js&#13;&#10;selectdate.js&#13;&#10;~userfunc.js" ></div>'
		//SKbillsheet.unselectable = "on";
		SKbillsheet.contentEditable=true

		//pubDsMain.outerHTML ='<img id="pubDsMain" dsid="DsMain" style="display:none">'
		InitControlNo()
		oContXml = SetDom("<root></root>")
		AutoAddDsMain();		
		ChangeWinTitle("表单设计工具")
		try {
			bigmain.focus() ;
		//	SKbillsheet.focus();
		}catch(e){}
	}else{
	//if( sHtm != "空"){
		SKbillsheet.innerHTML=sHtm;
		//CopyToPub(sHtm)
	}
	if(TooContXml()){openobjlist();ShowAllField();}
	
	if(IsSpace(sHtm) == false && sHtm != "空") 
		blnChange = true;
	else
		blnChange = false;
	
}
/**
表单另存
*@date 2004-08-04
**/
function DesignDjSaveAs(){
	var sRet=window.showModalDialog("input.htm","","status:no;dialogHeight:120px;dialogWidth:400px;dialogTop:180;dialogLeft:250px") 
	if(typeof sRet=="undefined") return
	//SKbillsheet.dj_sn=sRet
	SKbillsheet.dj_name=sRet
	curdjid=0;
	DesignDjSave()	
	ChangeWinTitle(SKbillsheet.dj_sn)
}

/**
表单另存为模板
*@date 2008-05-14
**/
function DesignDjSaveAsTemplate(){			
	if(confirm("您确认要将该表单保存为表单模板吗？")){
		var mydjname = window.showModalDialog("../dj/inputTemplateName.jsp");
		if(mydjname=="undefined" || mydjname == null){
			return;
		}else{
			SKbillsheet.caption = mydjname;
		}
		curdjid=0;  //表示保存的时候要重新生成id。
		saveAsTemplate = 1; //表示保存为模板。
		DesignDjSave();
	}		
}
/**
存盘前提示
*@date 2004-08-05
**/
function SaveTip(){
	if(blnChange == false) return 
	var ret = window.confirm("确定保存当前表单吗？");		
	if (ret == true) {
		DesignDjSave();
	}

	return ret;
}

/**
保存找到当前表单中控件的号码
*@date 2004-08-04
**/
function SaveControlNo() {
//ArrNum['SKButton']++
	var sRet=""
	for(var Num=0;Num<ArrName.length;Num++){
		sRet+=ArrName[Num]+":"+ArrNum[ArrName[Num]]+";" ;
//		sRet+=ArrNum[ArrName[Num]]+";" ;
	}
	sRet=sRet.substring(0,sRet.length-1);
	return sRet ;
}

function window_onbeforeunload() {
	
	if(blnChange == false) return 
	event.returnValue="离开当前页面将导致当前输入的数据丢失!"
}

function main_onbeforeeditfocus() {
	var obj = event.srcElement ;
	if(obj.tagName == "TD" ||obj.id =="SKbillsheet" ) return ;
	event.returnValue = false
}
function main_exec(scomm) {
	document.execCommand(scomm)

}
function window_onresize() {
	var iwidth =document.body.offsetWidth - 2
	var iheight =document.body.offsetHeight - 2
	if(iwidth<0) iwidth=100;
	if(iheight<0) iheight=100;
	srcHtml.style.width = iwidth
	srcHtml.style.height = iheight
	//如设置了窗口宽度,则始终是设置的宽度值,否则为窗口的宽度
	var iwidth1 = parseInt(SKbillsheet.poswidth)
	if(isSpace(SKbillsheet.poswidth) == false ){
		//if(bigmain.offsetWidth < iwidth1 ){
			bigmain.style.width = iwidth1
		//}
	}else{
		bigmain.style.width = iwidth
	}
	var iheight1 = parseInt(SKbillsheet.posheight)
	if(isSpace(SKbillsheet.posheight) == false ){
		//if(bigmain.offsetHeight < iheight1 ){
			bigmain.style.height = iheight1
		//}
	}else{
		bigmain.style.height = iheight
	}
	//middlediv.style.width = bigmain.style.width
	//middlediv.style.height = bigmain.style.height
}
/**
删除ocontxml中值相同的节点
*@date 2005-03-30
**/
function DelSameNameNode() {
	var curid = ""
	var l=oContXml.documentElement.childNodes.length
	for(var i=0;i<l;i++){
		var l1 = oContXml.documentElement.childNodes(i).childNodes.length
		for(var j=l1-1;j>=0;j--){
			if(curid == oContXml.documentElement.childNodes(i).childNodes(j).text) {
				oContXml.documentElement.childNodes(i).removeChild(oContXml.documentElement.childNodes(i).childNodes(j))
				continue
			}
			curid = oContXml.documentElement.childNodes(i).childNodes(j).text ;
		}
	}
}

/**
* 由界面上的控件 ==> oContXml 
*@return false 表示id重复,没有做同步工作,
*@date 2005-04-19
**/
function TooContXml() {
	var sRet = "<root>"
	var arrXml = new Array()
	var o = SKbillsheet.all
	var l=o.length ;
	for(var i=0;i<l;i++){
		var sid = o[i].id
		var scontroltype = o[i].controltype
		if(typeof(sid) == "undefined" ) continue
		//如没有controltype,表示是旧的控件,则要补上,2006-01-23 remove
		/*
		if(typeof(scontroltype) == "undefined") {
			var ll=ArrName.length;
			for (var ii=0;ii<ll;ii++){
				if (sid.indexOf(ArrName[ii])==0){
					o[i].controltype = ArrName[ii] ;
					scontroltype = o[i].controltype ;
					break ;
				}
			}
			
		}*/
		
		if(typeof arrXml[scontroltype] == "undefined") arrXml[scontroltype] =""
		var tmp = "<id>"+ sid +"</id>" ;
		if(arrXml[scontroltype].indexOf(tmp) >= 0  && sid != "" && sid != "fcpagesub" && sid != "fcpagesubtable" ){
			alert("注意: "+sid+"重复!请修改." )
			return false ;
		}else if(sid == "" || sid == "fcpagesub" || sid == "fcpagesubtable"){
			
		}else{
			arrXml[scontroltype] += tmp ;
		}
		
	}
	var l = ArrName.length ;
	for(var i=0;i<l;i++){
		if(isSpace(arrXml[ArrName[i]]) == false){
			sRet += "<"+ ArrName[i] +">" + arrXml[ArrName[i]]+"</"+ ArrName[i] +">"
			
		}
	}
	
	sRet += "</root>"
	
	
	oContXml = SetDom(sRet) ;
	//计算新的tab串
	//SKbillsheet.billtaborder = "" ; //清空以重算
	SKbillsheet.billtaborder = TaborderXml() ;
	return true
}	
/**
* 在设计窗口点右键菜单的调用
*@date 2005-08-11
**/
function main_onRightClick() {
	var tagName = event.srcElement.tagName ;
	
	if(tagName == "TD"){
		//RightMenu.DataSource="MenuTab.value" ;
		RightMenuTab.showMenu(window,RightMenuTab.dataSource.documentElement.selectSingleNode('//MenuItem'),window.document.body,event.x,event.y) ;
	}else{
		//RightMenu.DataSource="MenuCode.value" ;
		RightMenu.showMenu(window,RightMenu.dataSource.documentElement.selectSingleNode('//MenuItem'),window.document.body,event.x,event.y) ;
	}
		//RightMenu.Init() ;
		

}
/**
*设置TD上选中的文本的属性
*@date 2005-08-22
**/
function SetSelTextProp() {
	var sRet=DjOpen('fcs_selprop',window,'展现','无模式窗口','直接','设置当前选中文本的属性');
}
/*
function bill_ondrop() {
	event.returnValue = false
	//alert(event.srcElement.outerHTML)
	//var s1 = event.dataTransfer.getData("Text") ;
	
}*/

function mytest(){
	var oControlRange = document.body.createControlRange();
	//oControlRange.add(SKbillsheet);
	oControlRange.select();

//	event.returnValue =false
//	test1.value=SaveControlNo()
}
function mytest1(){
	//OpenControlNo(test1.value)
	htmltocont('<button controltype="FCButton" id="FCButton1" >aa</button>','FCButton')
}

//-->.
/*设置body的背景图片，使其在白板和网格之间进行切换。*/
function setBodyBackgroud(){
    if(document.body.style.background == "url(../images/blank.bmp)"){        
        document.body.style.background = "url('../images/grid.bmp')";
    }else{       
		document.body.style.background = "url('../images/blank.bmp')";
	}
}

/*
added by zhou.luo in 2008-09-26
表单自动绘制函数
*/
function creator_formDraw(formRet,ds_id,eform_class){
    //alert("in creator_formDraw: "+formRet);
    DesignStr_RunStr_Before(SKbillsheet);
    var designbak = SKbillsheet.outerHTML;
    var obj_ds = eval(ds_id);
    var queryField = "";
    var showField = "";   
    if(obj_ds.myField!=undefined){
    	var arrFields = obj_ds.myField.split(";");
    	for(var i =0;i < arrFields.length;i++){
            var arr = arrFields[i].split(",");
            if(arr[1]=='是'){
                queryField += arr[0] + ",";
            }
            if(arr[2]=='是'){
                showField += arr[0] + ",";
           	} 
    	}
    	if(queryField.length>0){
        	queryField = queryField.substring(0,queryField.length-1);
   		}
    	if(showField.length>0){
        	showField = showField.substring(0,showField.length-1);
    	}
    	//alert("queryField:"+queryField);
    	//alert("showField:"+showField);
    }
    //alert("eform_class:"+eform_class);
    //window.showModalDialog("test.jsp",obj_ds.outerHTML);
    
    var ds_design="<![CDATA["+TransSql(obj_ds.outerHTML)+"]]>";
    DesignStr_RunStr_Before0();
    var ds_run = SKbillsheet.outerHTML; 
    ds_run = DesignStr_RunStr_After(ds_run,ArrNum);    
    SKbillsheet.outerHTML = designbak;
    ds_run = ds_run.substring(ds_run.indexOf('<fc:dataset'),ds_run.indexOf('</fc:dataset>')+13);
    //window.showModalDialog("test.jsp",ds_run);
    ds_run="<![CDATA["+TransSql(ds_run)+"]]>";
    var myopensql = obj_ds.opensql;
    var isSuccess = creator_formDrawSend(ds_design,ds_run,formRet,queryField,showField,eform_class,myopensql);
    if(isSuccess=="true"){
        alert("生成成功！");
    }else{
        alert("生成失败！");
    }
}
		</SCRIPT>
	</HEAD>	
	<BODY background="../images/grid.bmp" onbeforeunload="window_onbeforeunload()" onload="window_onload()" id="mainbody"
	onresize="window_onresize()" onunload="UnLoadWebOffice()"
		>
		<!--<input type="button" value="test" onclick="mytest()"><input id=test1 >
		<input type="button" value="test1" onclick="mytest1()" >
				<button onclick="document.execCommand('Delete')">test</button>
			<table border=1 style="table-layout:fixed;position:absolute">
				<colgroup><col style="width:60"><col style="width:160"><col style="width:100"></colgroup>
				<tr><td>aa</td><td>遗传2基因</td><td>遗传2基因ss</td></tr>
				<tr><td>aa</td><td><input id=test1 NAME="test1"></td><td>遗传1基因ss</td></tr>
				<tr><td>aa</td><td>遗传基因</td><td>遗传基因ss</td></tr>
			</table>
<button ID="Button1">设计</button><button ID="Button2">HTML</button>
		-->
		
		<div id="bigmain" ondblclick="main_ondblclick()" onbeforeeditfocus="main_onbeforeeditfocus()"
		onclick="window_onclick()" onkeydown="main_onkeydown()"
		onkeyup="main_onkeyup()" oncontextmenu="main_onRightClick()"
		
		
		>
		<div id="middlediv" style="overflow:auto;"  >
			<div id="SKbillsheet" oncontrolselect="controlselect()" jslib="fcopendj.js&#13;&#10;fcsavedj.js&#13;&#10;fcselfuse.js&#13;&#10;fcbasecont.js&#13;&#10;fcother.js&#13;&#10;selectdate.js&#13;&#10;~userfunc.js" >
			</div>
		</div>
		</div>
		
		<textarea rows="17" id="srcHtml" cols="73" style="display:none" >
		</textarea>
		
		<WebMenu DataSource="MenuCode.value" class="WebMenu" id="RightMenu" Width="100" Effect="3" MenuType="1" ></WebMenu>
		<textarea rows="17" id="MenuCode" cols="73" style="display:none" NAME="MenuCode">
				
				<Root>
					<MenuItem  hasSub="1" subWidth="160" >
							<MenuItem Func="javascript:CopyCont();main_onkeydel();" Text="剪切 ctrl+x" img="../images/ef_design_cut.gif" />  
							<MenuItem Func="javascript:CopyCont();" Text="复制 ctrl+c" img="../images/ef_design_copy.gif" />  
							<MenuItem Func="javascript:if(PasteCont()==false) main_exec('Paste');" Text="粘贴 ctrl+v" img="../images/ef_design_paste.gif" hasLine="1" />
							<MenuItem Func="javascript:main_onkeydel();" Text="删除	Del" img="../images/ef_design_delete.gif" hasLine="1"/>
							<MenuItem Func="javascript:main_ondblclick();" Text="属性" img="../images/ef_design_shuxing.gif" hasLine="1"/>
							<MenuItem Func="javascript:SetSelTextProp();" Text="选中文本属性" img="../images/ef_tab_cell_prop.gif" />  
					</MenuItem>
				</Root>

		</textarea>
		<WebMenu DataSource="MenuTab.value" class="WebMenu" id="RightMenuTab" Width="100" Effect="3" MenuType="1" ></WebMenu>
		<textarea rows="17" id="MenuTab" cols="73" style="display:none" >
				<Root>
					<MenuItem  hasSub="1" subWidth="160" >
							<MenuItem Func="javascript:editortab.buttonPress(editor,'TO-table-prop');" Text="表格属性" hasLine="1" img="../images/ef_tab_table_prop.gif" />  
							<MenuItem Func="javascript:editortab.buttonPress(editor,'TO-row-insert-above');" Text="在前面加一行" img="../images/ef_tab_row_insert_above.gif" />  
							<MenuItem Func="javascript:editortab.buttonPress(editor,'TO-row-insert-under');" Text="在后面加一行" img="../images/ef_tab_row_insert_under.gif" />  
							<MenuItem Func="javascript:editortab.buttonPress(editor,'TO-row-delete');" Text="删除当前行" img="../images/ef_tab_row_delete.gif" />  
							<MenuItem Func="javascript:editortab.buttonPress(editor,'TO-row-split');" Text="按行拆分单元格" hasLine="1" img="../images/ef_tab_row_split.gif" />
							  
							<MenuItem Func="javascript:editortab.buttonPress(editor,'TO-col-insert-before');" Text="在前面加一列" img="../images/ef_tab_col_insert_before.gif" />  
							<MenuItem Func="javascript:editortab.buttonPress(editor,'TO-col-insert-after');" Text="在后面加一列" img="../images/ef_tab_col_insert_after.gif" />  
							<MenuItem Func="javascript:editortab.buttonPress(editor,'TO-col-delete');" Text="删除当前列" img="../images/ef_tab_col_delete.gif" />  
							<MenuItem Func="javascript:editortab.buttonPress(editor,'TO-col-split');" Text="按列拆分单元格" hasLine="1" img="../images/ef_tab_col_split.gif" />

							<MenuItem Func="javascript:editortab.buttonPress(editor,'TO-cell-prop');" Text="单元格属性" hasLine="1" img="../images/ef_tab_cell_prop.gif" />  
							<MenuItem Func="javascript:editortab.buttonPress(editor,'TO-cell-insert-before');" Text="在前面加单元格" img="../images/ef_tab_cell_insert_before.gif" />  
							<MenuItem Func="javascript:editortab.buttonPress(editor,'TO-cell-insert-after');" Text="在后面加单元格" img="../images/ef_tab_cell_insert_after.gif" />  
							<MenuItem Func="javascript:editortab.buttonPress(editor,'TO-cell-delete');" Text="删除当前单元格" img="../images/ef_tab_cell_delete.gif" />  
							<MenuItem Func="javascript:editortab.buttonPress(editor,'TO-cell-merge');" Text="合并单元格" img="../images/ef_tab_cell_merge.gif" />  
							<MenuItem Func="javascript:editortab.buttonPress(editor,'TO-cell-split');" Text="拆分单元格" hasLine="1" img="../images/ef_tab_cell_split.gif" />  
							
							<MenuItem Func="javascript:SetSelTextProp();" Text="选中文本属性" img="../images/ef_tab_cell_prop.gif" />  

					</MenuItem>
				</Root>

		</textarea>	
		
	</BODY>
</HTML>
