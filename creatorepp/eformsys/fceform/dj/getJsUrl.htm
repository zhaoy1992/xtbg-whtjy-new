<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html xmlns:fc xmlns:v="urn:schemas-microsoft-com:vml">
	<HEAD>
		<meta http-equiv="Content-Type" content="text/html; charset=gbk" />
		<STYLE> .userData{behavior:url(#default#userData);}
	@import url(../css/dj.css); 
.menu{
	position:absolute;
	width : 100px;
	visibility:hidden;
	background-color:#F1F3F2;
	z-index:10000;
	border : 1px solid black;
}
.item{
	margin:0;
	text-align:center;
	font:"宋体";
	font-size:12px;
}
.item a{
	width:99%;
}
.item a:link   {
	text-decoration:none; 
} 
.item a:hover  {
	color: blue; 
	background-color:skyblue;
}
.item a:visited  {
	text-decoration:none; 
	color: blue; 
} 
.hrcss{
	width:95%;
}
	</STYLE>
		<script src="../js/fcpub.js"></script>
		<script src="../js/fcrundj.js"></script>
		<script src="../js/tabpane.js"></script>	
		<link rel="stylesheet" type="text/css" href="../../fceform/js/Ext/css/ext-all.css" />
		<script type="text/javascript" src="../../fceform/js/Ext/ext-base.js"></script>
		<script type="text/javascript" src="../../fceform/js/Ext/ext-all-debug.js"></script>
		<script type="text/javascript" charset="utf-8" src="../../fceform/js/Ext/ext-lang-zh_CN.js"></script>
		<link rel='stylesheet' type='text/css' href='../../fceform/js/Ext/css/SwfUploadPanel.css' />
		<script type='text/javascript' charset='GBK' src='../../fceform/js/Ext/SwfUpload.js'></script>
		<script type='text/javascript' charset='GBK' src='../../fceform/js/Ext/SwfUploadPanel.js'></script>	
	</HEAD>
	<body background="../images/ef_run_background.gif" onload="pub_window_onload()"
		onkeydown="RunTabindex()" onbeforeunload="pub_window_onbeforeunload()" onkeypress="pub_window_onkeypress()"
		onresize="pub_window_onresize()">
		<script>
var pubdjbh=parent.sOpenDjNo;
var pubEdit=false;   			
var pubDataSet=null;
var pubRequest=parent.oRequest;
var pubEformEnterStatus="OK"; 
pub_djhtm();
		</script>
<script>var initPath ; //初始路径,无论是否为绝对路径
var offsetPath ="" ; //通过在此界面上操作产生的偏移路径
var strType = "file"; //=url表示只返回和显示目录
var isVir = "yes" //是否虚拟目录.yes:虚拟根目录则传“../”或“”或“..”,其它按目录结构列../JHSoft.Web.Module ；no:E:\ 
var displayType = "list";	//显示方式, =list 表示多列且只显示名称
var fileExts = ""; //显示的文件扩展名 htm|js|txt|jpg|gif
var curSel = null ; //当前选中即变了颜色的span对象.
var isWriteName = "no"; //是否写文件名
function uf_open()
{
	document.oncontextmenu = function (){
		var e = e||window.event;
		posx = e.clientX + (document.documentElement.scrollLeft || document.body.scrollLeft);
		posy = e.clientY + (document.documentElement.scrollTop || document.body.scrollTop);			
		var div = null;
		if(e.srcElement.tagName=="SPAN"){	
			hidenmenu("menu1");
			div = document.getElementById("menu");	
   			uf_changBgColor();
		}else{
			hidenmenu("menu");
			div = document.getElementById("menu1");	
		}
		div.style.visibility = "visible";
		div.style.top = posy;
		div.style.left = posx;
		e.returnValue=false;
  		e.cancelBubble=true;	
	};
	document.onclick = function(){
			hidenmenu("menu");
			hidenmenu("menu1");
	};
	initPath = pubDataSet[0];
	if(typeof initPath =="undefined"){
		alert("初始路径未定义!");
		window.close();
		return;
	}
	var sEnd = initPath.substring(initPath.length-1,initPath.length) ; 
	if(sEnd == "/" || sEnd == "\\") initPath = initPath.substring(0,initPath.length-1);
	
	if(IsSpace(pubDataSet[1]) == false)	strType = pubDataSet[1];
	if(IsSpace(pubDataSet[2]) == false)	isVir = pubDataSet[2];
	if(IsSpace(pubDataSet[3]) == false)	fileExts = pubDataSet[3];
	if(IsSpace(pubDataSet[4]) == false)	isWriteName = pubDataSet[4];
	if(isWriteName == "yes"){
		lblFileName.style.display = "";
		txtFileName.style.display = "";
	}

	SetButtonImage(btnUp,"../../fceform/images/ef_open_up.jpg");
	SetButtonImage(btnOK,"../../fceform/images/ef_run_button_ok.gif");
	SetButtonImage(btnCancel,"../../fceform/images/ef_run_button_close.gif");
	
	if (displayType == "")
		SetButtonImage(btnList,"../../fceform/images/ef_open_list1.jpg");
	else
		SetButtonImage(btnList,"../../fceform/images/ef_open_list.jpg");


	txtInitPath.value = initPath;
	div1.ondblclick = uf_GetSub ;
	div1.onclick = uf_changBgColor ;
	
	var strXml = "<Scope>"+initPath+"</Scope><ReturnType>"+strType+"</ReturnType><IsVir>"+isVir+"</IsVir><DisplayType>"+displayType+"</DisplayType><Files>"+fileExts+"</Files>";
	ShowWait("正在处理,请稍候...");
	SendHttp(location.protocol+"//"+location.host + fcpubdata.servletPath + "/PathFile"+fcpubdata.dotnetVersion+"?GetUrl",strXml,function (result){
		ShowWait("end");
		var sRet = result.value;
		if(sRet != null){
			if(sRet.substring(0,7) != "<table "){
				alert(sRet);
				window.close();	
				return;
			}
			$("div1").innerHTML = sRet;
		}
		uf_tableStyle();
		uf_ctrlDisabled(false);
		
	});
	
	uf_ctrlDisabled(true);
}
//确定返回
function uf_ok()
{
	var strTemp ;
	var strReturn = "";
	if(curSel != null) {
		strReturn =  curSel.innerText;
		if(curSel.type == "Dir" && strType == "file" && strReturn.length > 0 ){
			uf_GetSub(curSel);
			return;
		}
	}
	if(strType == "url" && tab1.rows.length == 0){
		strTemp = offsetPath;
	}else if (strType == "file" && strReturn.length == 0 && isWriteName == "no"){
		alert("请选择文件。");
		return; 
	}else if (strType == "file" && strReturn.length == 0 && isWriteName == "yes"){
		strTemp = offsetPath;
	}else{
		strTemp = offsetPath+"/"+strReturn;
	}
	//alert(strTemp+"=="+curSel.innerText);
	if(isWriteName == "yes") {
		if(IsSpace(txtFileName.value)){
			alert("请输入文件名");
			return;
		}
		strTemp = strTemp +"/" +  txtFileName.value ;
	}
	window.returnValue = strTemp;
	window.close();
}

function uf_ctrlDisabled(blDisabled)
{
	$("btnUp").disabled = blDisabled ;
	$("btnList").disabled = blDisabled ;
	$("div1").disabled = blDisabled ;
}

//表格样式
function uf_tableStyle()
{
	if ($("div1").innerHTML.length>0)
		$("tab1").style.fontSize = "12px";	
}

//替换背景色
function uf_changBgColor()
{
	var spanColor = "#f6f6f6";
	if (displayType != "") 	spanColor = "#FFFFFF";
	if (event.srcElement.tagName.toLowerCase() == "span")
	{
		var obj = event.srcElement;
		if(curSel != null ){
			curSel.style.backgroundColor = spanColor;
			curSel.style.color = "#000000";
		}

		obj.style.backgroundColor = "#3300cc";
		obj.style.color = spanColor;
		curSel = obj;
	}	
}

function hidenmenu(id){
		document.body.onclick = null;
		var div = document.getElementById(id);
		div.style.visibility = "hidden";
}

var File = {
	addfile : function(){winref.show();hidenmenu("menu");hidenmenu("menu1");},
	delfile : function(){Ext.Ajax.request({
			url: getContextPath()+'/servlet/CreatorPTServlet?key=JsDel',
			success: function(resonse){
				var resmessage = eval("("+resonse.responseText+")");
				if(IsSpace(resmessage.error)){
					alert("操作成功!");
				}
				if(txtInitPath.value==initPath){
					uf_open();
				}else {
					uf_GetSub({type:'Dir',innerText:''});
				}
			},			
			params: { uploadPath: txtInitPath.value+"/"+curSel.innerHTML.replace(/\<.*\>/g,'')}
		});
		hidenmenu("menu");
		hidenmenu("menu1");
	},
	addfolder:function(){
		var win = new Ext.Window({
		        title: '输入文件夹名称',
		        closeAction:'hide',
		        width: 250,
		        height: 105,
				resizable: false,		
				layout:'border',
				items: [
					{
						id:'folderText',
						region:'center',
						xtype: 'textfield',
						emptyText:'输入文件夹名称'
					}
				],
				buttons:[{
					text     : '确认',
					handler  : function(){
						win.hide();
						Ext.Ajax.request({
							url: getContextPath()+'/servlet/CreatorPTServlet?key=JsAddFolder',
							success: function(resonse){
								var resmessage = eval("("+resonse.responseText+")");
								if(IsSpace(resmessage.error)){
									alert("操作成功!");
								}								
								uf_open();								
							},			
							params: { uploadPath: (txtInitPath.value+"/"+folderText.value)}
						});
					}
				},{
					text     : '取消',
					handler  : function(){
						win.hide();
					}
				}]				
		});
		win.show();		
		hidenmenu("menu");
		hidenmenu("menu1");
	}
};

//查询子目录及文件
function uf_GetSub(objSpan)
{
	if(typeof objSpan == "undefined"){
		if (event.srcElement.tagName.toLowerCase() != "span") return;
		var obj = event.srcElement;
	}else{
		var obj = objSpan;
	}
	if (obj.type == "Dir")
	{
		if(obj.innerText!=""){
			var tmp1 = offsetPath+"/"+obj.innerText ;
		}else{
			var tmp1 = offsetPath;
		}
		var strXml = "<Scope>"+(initPath+tmp1)+"</Scope><ReturnType>"+strType+"</ReturnType><IsVir>"+isVir+"</IsVir><DisplayType>"+displayType+"</DisplayType><Files>"+fileExts+"</Files>";
		SendHttp(location.protocol+"//"+location.host + fcpubdata.servletPath + "/PathFile"+fcpubdata.dotnetVersion+"?GetUrl",strXml,function (result){
			var sRet = result.value;
			if(sRet.substring(0,7) != "<table "){
				alert(sRet);
				return;
			}
			$("div1").innerHTML = sRet;
			//alert(tmp1);
			offsetPath =tmp1;
			txtInitPath.value = initPath +offsetPath;
			uf_tableStyle();
			
		});	
		
	}
	if (obj.type == "File")
	{
		uf_ok();	
	}	
}

//返回上级目录
function uf_GoUp()
{
	if(offsetPath == "") {
		alert("已到根目录!");
		return;
	}
	var ipos = offsetPath.lastIndexOf("/");
	if(ipos<0) return;
	var sTmp = offsetPath.substring(0,ipos);
	
	var strXml = "<Scope>"+(initPath+sTmp)+"</Scope><ReturnType>"+strType+"</ReturnType><IsVir>"+isVir+"</IsVir><DisplayType>"+displayType+"</DisplayType><Files>"+fileExts+"</Files>";
	SendHttp(location.protocol+"//"+location.host + fcpubdata.servletPath + "/PathFile"+fcpubdata.dotnetVersion+"?GetUrl",strXml,function (result){
		var sRet = result.value;
		if(sRet.substring(0,7) != "<table "){
			alert(sRet);
			return;
		}
		$("div1").innerHTML = sRet;
		offsetPath = sTmp;
		txtInitPath.value = initPath +offsetPath;
		uf_tableStyle();
		
	});	
	
		
}


//列表式装载文件
function uf_LoadList()
{
	if (displayType == "")
	{
		displayType = "list";
		SetButtonImage(btnList,"../../fceform/images/ef_open_list.jpg");
	}
	else
	{
		displayType = "";
		SetButtonImage(btnList,"../../fceform/images/ef_open_list1.jpg");
	}
	
	var strPath = initPath + offsetPath;
	var strXml = "<Scope>"+strPath+"</Scope><ReturnType>"+strType+"</ReturnType><IsVir>"+isVir+"</IsVir><DisplayType>"+displayType+"</DisplayType><Files>"+fileExts+"</Files>";
	//alert(strXml);
	SendHttp(location.protocol+"//"+location.host + fcpubdata.servletPath + "/PathFile"+fcpubdata.dotnetVersion+"?GetUrl",strXml,function (result){
			var sRet = result.value;
			uf_ctrlDisabled(false);
			if(sRet.substring(0,7) != "<table "){
				alert(sRet);
				return;
			}
			$("div1").innerHTML = sRet;
			uf_tableStyle();
			
		});
	uf_ctrlDisabled(true);
}
var winref;
</script><script src='../js/fcopendj.js'></script><script defer src='../js/fcsavedj.js'></script><script src='../js/fcselfuse.js'></script><script src='../js/fcbasecont.js'></script><script defer src='../js/fcother.js'></script><script defer src='../js/selectdate.js'></script><script src='../../fceformext/js/userfunc.js'></script><link href=../css/tabstyle.css type=text/css rel=stylesheet><link type='text/css' rel='stylesheet' href='../css/Button.css'/><link type='text/css' rel='stylesheet' href='../css/TextStyle.css'/>
  <div id="menu" class="menu">
  <div class="item"><a href="javascript:File.delfile()">删除</a></div>
  </div>
  <div id="menu1" class="menu">
  <div class="item"><a href="javascript:File.addfile()">新增文件</a></div><hr class="hrcss"/>  
  <div class="item"><a href="javascript:File.addfolder()">创建目录</a></div>
  </div>
<DIV id=div_ExtUpload1 style="LEFT: 95px; POSITION: absolute; TOP: 56px"></DIV>
<SCRIPT type=text/javascript>Ext.BLANK_IMAGE_URL = '../../fceform/js/Ext/images/default/s.gif';var w_ExtUpload1 = 350;var h_ExtUpload1 = 200;var upobj_ExtUpload1;Ext.onReady(function(){    var urls = getContextPath()+'/servlet/CreatorPTServlet?key=JsAddFile';    var uploadFinishFlag = false;    function createUpload(){        var uploader = new Ext.ux.SwfUploadPanel({            title: '上传文件',            width: w_ExtUpload1,            height: h_ExtUpload1,            collapsible: true,            file_size_limit: '16000',            fc_addfiles: true,            fc_delfiles: true,            fc_uploadfiles: true,            upload_url: urls,            flash_url: '../../fceform/js/Ext/swfupload.swf',            single_file_select: false,            confirm_delete: false,            remove_completed: false,            file_types: '*.js;*.css;*.htm'        });                uploader.on('uploadStart', function(t){ this.addPostParam("uploadPath",txtInitPath.value); });        uploader.on('fileDialogStart', function(t){            if (uploadFinishFlag) {                t.store.removeAll();                uploadFinishFlag = false;            };                    });        uploader.on('allUploadsComplete', function(t){            uploadFinishFlag = true;            try { if(txtInitPath.value==initPath){ uf_open(); }else {uf_GetSub({type:'Dir',innerText:''});}  }             catch (e) {         }        });        upobj_ExtUpload1 = uploader;		uploader.getColumnModel().setHidden(3,true);        return uploader;    }    var win = new Ext.Window({        title: '上传窗口',closeAction:'hide',        width: w_ExtUpload1 + 20,        height: h_ExtUpload1 + 60,        resizable: false,        items: [createUpload()]    }); winref = win;});</SCRIPT>
<DIV id=SKbillsheet jslib="fcopendj.js&#13;&#10;fcsavedj.js&#13;&#10;fcselfuse.js&#13;&#10;fcbasecont.js&#13;&#10;fcother.js&#13;&#10;selectdate.js&#13;&#10;~userfunc.js" OtherSave="否" toolbar="不带工具栏" idtype="1" isfile="否" postop posleft window="有模式窗口" keyfield controlno="SKButton:0;SKDBedit:0;checkbox:0;label:4;radio:0;listbox:0;textarea:1;combobox:0;password:0;upload:0;SKDBtext:0;chart:0;dbimg:0;img:1;SKBILLgrid:0;shape:0;tab:0;div:2;DsMain_field:0;a:0;button:4;text:5;hr:0;checkboxlist:0;radiolist:0;dropdownlist:0;grid:0;dataset:0;spin:0;excel:0;tree:0" posheight="400" poswidth="500" entertype="修改" codeheader="BBB" mkbh caption="选择文件" type="ST" dj_sn="getUrl" billtaborder="<root><taborder>btnUp</taborder><taborder>btnCancel</taborder><taborder>btnList</taborder><taborder>txtInitPath</taborder><taborder>txtFileName</taborder><taborder>btnOK</taborder></root>" contxml="<root><label><id>label2</id><id>lblFileName</id></label><div><id>div1</id></div><button><id>btnUp</id><id>btnCancel</id><id>btnList</id><id>btnOK</id></button><text><id>txtInitPath</id><id>txtFileName</id></text></root>" center="居中" BLONopen="uf_open();"><BUTTON id=btnUp style="DISPLAY: block; FONT-SIZE: 12px; LEFT: 422px; WIDTH: 25px; FONT-FAMILY: ; POSITION: absolute; TOP: 1px; HEIGHT: 25px; BACKGROUND-COLOR: #ffffff" onmovestart=moveStart() controltype="button" onclick='bill_onclick("uf_GoUp();")' dropstyle="否"></BUTTON> 
<DIV id=div1 style="BORDER-RIGHT: black 1px solid; BORDER-TOP: black 1px solid; OVERFLOW-Y: auto; FONT-SIZE: 10pt; LEFT: 3px; OVERFLOW-X: auto; OVERFLOW: auto; BORDER-LEFT: black 1px solid; WIDTH: 483px; BORDER-BOTTOM: black 1px solid; FONT-STYLE: normal; FONT-FAMILY: 宋体; POSITION: absolute; TOP: 28px; HEIGHT: 315px; BACKGROUND-COLOR: #ffffff" onmovestart=moveStart() controltype="div" NotBg="否"></DIV><BUTTON id=btnCancel style="DISPLAY: block; FONT-SIZE: 12px; LEFT: 400px; WIDTH: 76px; FONT-FAMILY: ; POSITION: absolute; TOP: 344px; HEIGHT: 25px; BACKGROUND-COLOR: #ffffff" onmovestart=moveStart() controltype="button" onclick='bill_onclick("window.close();")' dropstyle="否"></BUTTON><BUTTON id=btnList style="DISPLAY: block; FONT-SIZE: 12px; LEFT: 452px; WIDTH: 25px; FONT-FAMILY: ; POSITION: absolute; TOP: 1px; HEIGHT: 25px; BACKGROUND-COLOR: #ffffff" onmovestart=moveStart() controltype="button" onclick='bill_onclick("uf_LoadList();")' dropstyle="否"></BUTTON> 
<DIV id=label2 style="LEFT: 15px; WIDTH: 35px; POSITION: absolute; TOP: 7px; HEIGHT: 15px" onmovestart=moveStart() noWrap controltype="label" NotBg="否" value="label2">路径：</DIV><INPUT id=txtInitPath style="LEFT: 52px; WIDTH: 361px; POSITION: absolute; TOP: 4px; HEIGHT: 20px" onmovestart=moveStart() readOnly size=62 controltype="text"> 
<DIV id=lblFileName style="DISPLAY: none; LEFT: 8px; WIDTH: 45px; POSITION: absolute; TOP: 353px; HEIGHT: 15px" onmovestart=moveStart() noWrap controltype="label" NotBg="否" value="label4">文件名:</DIV><INPUT id=txtFileName style="DISPLAY: none; LEFT: 59px; WIDTH: 225px; POSITION: absolute; TOP: 350px; HEIGHT: 20px" onmovestart=moveStart() size=40 controltype="text"><BUTTON id=btnOK style="DISPLAY: block; FONT-SIZE: 12px; LEFT: 318px; WIDTH: 76px; FONT-FAMILY: ; POSITION: absolute; TOP: 344px; HEIGHT: 25px; BACKGROUND-COLOR: #ffffff" onmovestart=moveStart() controltype="button" onclick='bill_onclick("uf_ok()")' dropstyle="否"></BUTTON></DIV></body></html>