<html xmlns:fc>
<head>
<title></title>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<STYLE type=text/css>
  fc\:dataset  {  behavior: url(../htc/dataset.htc) ;  }
  fc\:webgrid {  behavior: url(../htc/webgrid.htc) ; }

	.tdfilter { 
	    filter: Invert;
		background-color:#ffff32 ;
	 }  
	.invert { 
	    filter: Invert;
		background-color:#e6e6fa;
	 }  

  
</STYLE> 
<script src="../js/fcpub.js"></script>
<script src="../js/fcdataset.js"></script>
<script src="../js/fcwebgrid.js"></script>

</head>
<body onload="initdbNameselect();window_onload()" onkeydown="form_onkeydown()"  >
<br style="font-size:5px;"/>
<span style="font-size:14;margin-left:5px;">数据源:</span><select onchange="window_onload()" id="dbNameSelect" style="DISPLAY: block; FONT-SIZE: 12px; LEFT: 60px; WIDTH: 64px; FONT-FAMILY: ; POSITION: absolute; TOP: 5px; HEIGHT: 25px; BACKGROUND-COLOR: #d4d0c8" ></select>
<table cellpadding="0" style="margin-top:4px" cellspacing="0" width="98%" align="center" bordercolor="#336699" border="1"  bgcolor="#336699">
<tr bgcolor="#e8f4ff">
<td bgcolor="336699" >
      <TABLE  cellSpacing=1 cellPadding=0 width="100%">
        <TBODY>
        <TR>
        <TD>&nbsp;<BUTTON language=javascript id=button_ok 
            onclick="return gridDblClick('点击确定')" attrib="button">&nbsp;确定&nbsp;</BUTTON>
            &nbsp;<BUTTON language=javascript id=button_cancel 
            onclick="javascript:window.close();" attrib="button">&nbsp;取消&nbsp;</BUTTON></TD>
      <td align="right">
      <table border="0" cellSpacing=0 cellPadding=0>
      <tr>
      <TD><BUTTON language=javascript id=button_first style="font-Family:Webdings; " disabled
            onclick="return pagemove(1)" attrib="button">&nbsp;9&nbsp;</BUTTON></TD>
          <TD><BUTTON language=javascript id=button_pre style="font-Family:Webdings; "  disabled
            onclick="return pagemove(2)" attrib="button">&nbsp;7&nbsp;</BUTTON></TD>
          <TD><BUTTON language=javascript id=button_next style="font-Family:Webdings; " disabled
            onclick="return pagemove(3)" attrib="button">&nbsp;8&nbsp;</BUTTON></TD>
          <TD><BUTTON language=javascript id=button_last style="font-Family:Webdings; " disabled
            onclick="return pagemove(4)" attrib="button">&nbsp;:&nbsp;</BUTTON></TD>
      </tr>
      </table>
      </td>
      </TR></TBODY></TABLE>
</td>
</tr>
<tr bgcolor="#FFFCEE">
<td height="246" align="left" ></td>
</tr>
</table>

<fc:dataset id="dsSel" ></fc:dataset>
<fc:webgrid id="grid" dataset="dsSel" style="POSITION:  absolute; TOP: 20px;" height=200 width=448  onDblClick="gridDblClick()"  >
<table id=t cellPadding=0 cellSpacing=0  frame=box   style="BORDER-COLLAPSE: collapse;  TABLE-LAYOUT: fixed ;LEFT: 2px; POSITION:  absolute; TOP: 2px;BACKGROUND-COLOR:#FFFFFF ;FONT-FAMILY:MS Sans Serif;FONT-SIZE:11px;color:#000000 "  > <tr style="BACKGROUND-COLOR:#EBEADB ;FONT-FAMILY:MS Sans Serif;FONT-SIZE:11px;color:#000000 " ><td></td></tr>  </table> 
</fc:webgrid>
</body>
</html>
<script language="JavaScript" type="text/javascript">
 	var Parent //定义了传递过来的参数（window）
    Parent=window.dialogArguments[0]
 	var sql=window.dialogArguments[1]
 	var ogrid=window.dialogArguments[2]
 	//带,分隔的隐藏字段
 	var undispflds=window.dialogArguments[3]
 	//是否允许多选
 	var multisel=window.dialogArguments[4]
	var stmp = window.dialogArguments[6];
 	if(stmp.length > 40 ) stmp = "" ; // >40 表示是一个xml串,则不显示到标题上
        window.document.title="资料选择方案："+stmp;

function initdbNameselect(){
	var dbnames = SendHttp(location.protocol+"//"+location.host+ fcpubdata.servletPath + "/CreatorPTServlet"+fcpubdata.dotnetVersion+"?key=getDbNames");
	dbnames = dbnames.replace(/\|\|$/g,'');	
	var arr = dbnames.split("||");
	var dbSelectops = document.getElementById('dbNameSelect').options;
	for(var i=0,len = arr.length;i<len;++i){
		var temp = arr[i];
		dbSelectops.add(new Option(temp,temp));
	}
}


function FindAll(){    
	var bln=dsSel.FindAll(txtFind.value,true)
	
	//alert(bln)
} 
function window_onload(){  
	//var wait=ShowWait('正在装入....');

		//	var d=new Date()
		//	var t = d.getTime();

   // initDocument();
    var dbName = document.getElementById('dbNameSelect').value;
    grid.top=39;   
    grid.left=10;
    grid.ReadOnly=false;    
    dsSel.PageSize=50 ;
    dsSel.HideField=undispflds ;
	var ssql  ='';
    if(sql.indexOf('where')!=-1){
    	ssql = sql.replace(/where/,"where dbname='"+dbName+"' and " )
    }else{
    	ssql= sql + " where dbname = '"+dbName+"'";
    }
    dsSel.opensql=ssql ;
    dsSel.Open(ssql,"",function (result) { 
		adjugebutton();
		window.setTimeout("try {grid.SetFocus(null,'程序给焦点');grid.curTD.focus();} catch (e){}", 10);
    }) ;
    //hidefield()
   // ShowWait("end");
}
/**
*处理隐藏字段
*@date 2003-08-21
**/
function hidefield(){

    if(isSpace(undispflds)==false && isSpace(grid.format)==false){
		var oXml=new ActiveXObject("Microsoft.XMLDOM")
		oXml.async=false
		oXml.loadXML (grid.format) 

    	var arr=undispflds.split(",")
    	for(var i=0;i<arr.length;i++){
    		for(var j=0;j<oXml.documentElement.childNodes.length;j++){
    			if(trim(arr[i].toUpperCase())==trim(oXml.documentElement.childNodes(j).childNodes(0).text.toUpperCase()) ){
    				grid.tab.children(0).children(j+1).style.width=0
    				break
    			}
    		}
    	}
    	
    }
}
/**
*param sTag =点击确定 表示点击确定按钮时调用它
**/
function gridDblClick(sTag){
	if(multisel == "是" && sTag != "点击确定" ){
		//在第一列打勾
		GridMultiSel(grid,dsSel)
		return
	} 

	var oDs 
	if(dsSel.RecordCount>0){
		//复制数据集

		//copydataset(dsSel,Parent.DsMain)
		//Parent.DsMain.fset_cont1()
		//表格
		if(typeof ogrid!="undefined"){
			var oParentDataSet=eval("Parent."+ogrid.dataset)
			if(multisel == "是" && sTag == "点击确定" ){
				if(copydatasetsel(dsSel,oParentDataSet)){
					self.close(); 
					return;
				}
			}else{
				/*
				for(var i=0;i<dsSel.FieldCount;i++){        
					for(var j=0;j<oParentDataSet.FieldCount;j++){    
						if(oParentDataSet.Fields.Field[j].FieldName.toUpperCase()==dsSel.Fields.Field[i].FieldName.toUpperCase()){
							if(oParentDataSet.bAdd==false) oParentDataSet.bEdit=true
							oParentDataSet.Fields.Field[j].Value=dsSel.Fields.Field[i].Value;
							break 
						}	     
					}
				}*/
				copydataset(dsSel,oParentDataSet);
				//下面两行为2005-07-27时加，因为表格单选不能提交到数据集
				oParentDataSet.bEdit = true;
				oParentDataSet.Update("不检查")  ;

				oParentDataSet.fset_cont();
				ogrid.RefreshEdit()
				//如为最后行,则将最后行状态改为编辑状态
				if(ogrid.Row==ogrid.Rows-1){
				ogrid.EndRowState="edit"
				}
			}
		} else { //DsMain数据集及零散控件
			var odstmp = eval("Parent."+GetDsMain(true))
			copydataset(dsSel,odstmp)
			odstmp.fset_cont1()
		
		
/*		
			var oContXml = SetDom(Parent.SKbillsheet.contxml)
			var oNode = oContXml.documentElement.selectSingleNode("imgwebgrid") ;
			var oNodeDs = oContXml.documentElement.selectSingleNode("imgdataset") ;
			if(oNodeDs != null ){
				for(var i=0;i<oNodeDs.childNodes.length;i++){
					//判断数据集是否绑定在表格上
					var bool = false ;
					var s = oNodeDs.childNodes(i).text
					if(oNode != null ){
						for(var j=0;j<oNode.childNodes.length;j++){
							var otmp = eval("Parent."+oNode.childNodes(j).text) ;
							if(s == otmp.dataset ){
								bool=true
								break
							}
						}
					}
					if(bool == false){ 
						//没绑定到表格的数据集都进行复制
						var odstmp = eval("Parent."+oNodeDs.childNodes(i).text)
						copydataset(dsSel,odstmp)
						odstmp.fset_cont1()
					}
					
				}
			
			}
			*/			
		
		}

		//定义返回用于打开单据时
		window.returnValue="openbill"

	}
	self.close(); 
}
/**
*页面的KEYDOWN事件处理,处理pagedown pageup,up,down,enter键
**/
function form_onkeydown(){
	if (event.keyCode ==33){		//pageup
		dsSel.PrevPage()
			hidefield()
	}
	if (event.keyCode ==34){		//pagedown
		dsSel.NextPage()
			hidefield()
	}

	/*	
	if (event.keyCode ==40){		//向下键
		dsSel.MoveNext()
			hidefield()
	}
	if (event.keyCode ==38){		//向上键
		dsSel.MovePrev()
			hidefield()
	}

	*/
	if (event.keyCode ==13){		//回车键
		gridDblClick()
	}
	if (event.keyCode ==27){		//ESC键
		self.close()
	}

	if ( event.keyCode ==13 ){
		event.returnValue=false
	}
	if ( event.keyCode == 9 ){  //tab 键
		var o=event.srcElement
		switch (o.id) {
			case "button_ok" : button_cancel.focus();break;
			case "button_cancel" : 
				if(button_first.disabled){
					button_next.focus();
				}else {
					button_first.focus();
				}
				break;
			case "button_first" : button_pre.focus();break;
				
			case "button_pre" : 
				if(button_next.disabled){
					grid.SetFocus(null,"程序给焦点")
				}else {
					button_next.focus();
				}
				break;
			case "button_next" : button_last.focus();break;
			case "button_last" : grid.SetFocus(null,"程序给焦点");break;
			default : button_ok.focus(); break;
			
		}
		event.returnValue=false
	}

}

function pagemove(moveindex){
  if(moveindex==1){
    dsSel.FirstPage();
  }else if(moveindex==2){
    dsSel.PrevPage();
  }else if(moveindex==3){
    dsSel.NextPage();
  }else if(moveindex==4){
    dsSel.LastPage();
  }
  hidefield()
  adjugebutton();
  grid.SetFocus()
}
function adjugebutton(){
   //判断当前数据集的页面数
   var curpage=dsSel.PageNo;
   var countpage=dsSel.PageCount;
   var buttonfirst=document.getElementById("button_first");
   var buttonpre=document.getElementById("button_pre");
   var buttonnext=document.getElementById("button_next");
   var buttonlast=document.getElementById("button_last");

     /*--为了恢复按钮没有被按下时的颜色--*/
     setButtonDown(buttonfirst,false);
     setButtonDown(buttonpre,false);
     setButtonDown(buttonnext,false);
     setButtonDown(buttonlast,false);

     buttonfirst.disabled=true;
     buttonpre.disabled=true;
     buttonnext.disabled=true;
     buttonlast.disabled=true;   

   if(countpage>1){
       if(curpage>1){
         buttonfirst.disabled=false;
         buttonpre.disabled=false;
       }
       if(curpage<countpage){
         buttonlast.disabled=false;
         buttonnext.disabled=false;
       }
   }
}
function setButtonDown(button, down){
	button.down=isTrue(down);
	refreshButtonColor(button);
	/*--按钮事件函数--*/
	function refreshButtonColor(button){
		if (isTrue(button.getAttribute("down"))){
			button.className="button_down";
			button.style.backgroundColor="#fff1da";
		}
		else{
			button.className="button";
			button.style.backgroundColor="#d4d0c8";
		}
	}

}

</script>